<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KPB TS Surat Manager - OPSI B</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<style>
:root{
  --bg:#080a0f;--s1:#0f1219;--s2:#161b26;--s3:#1d2333;
  --b1:#232b3e;--b2:#2e3a52;--b3:#3d4e6a;
  --g:#00e5a0;--g2:rgba(0,229,160,.1);--g3:rgba(0,229,160,.05);
  --a:#4d9eff;--a2:rgba(77,158,255,.1);
  --w:#ffb347;--w2:rgba(255,179,71,.1);
  --r:#ff4d6d;--r2:rgba(255,77,109,.1);
  --p:#b57bee;--p2:rgba(181,123,238,.1);
  --tx:#dde3f0;--tx2:#7e8fa8;--tx3:#3d4d63;
  --mono:'JetBrains Mono',monospace;--sans:'Plus Jakarta Sans',sans-serif;
  --sh:0 8px 32px rgba(0,0,0,.5);--rad:10px
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--tx);font-family:var(--sans);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 60% at 20% -10%,rgba(0,229,160,.04),transparent 60%),radial-gradient(ellipse 60% 40% at 80% 100%,rgba(77,158,255,.04),transparent 60%);pointer-events:none;z-index:0}
::-webkit-scrollbar{width:4px;height:4px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--b2);border-radius:2px}

/* LOADING */
#loadingScreen{position:fixed;inset:0;z-index:1000;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px}
#loadingScreen.hidden{display:none}
.spinner{width:32px;height:32px;border:3px solid var(--b2);border-top-color:var(--g);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-txt{font-family:var(--mono);font-size:11px;color:var(--tx3);letter-spacing:1px}

/* SETUP */
#setupScreen{display:none;position:fixed;inset:0;z-index:998;background:var(--bg);align-items:center;justify-content:center;padding:20px;overflow-y:auto}
#setupScreen.show{display:flex}
.setup-card{background:var(--s1);border:1px solid var(--b1);border-radius:16px;padding:36px;width:100%;max-width:560px;box-shadow:var(--sh)}
.setup-step{display:none}.setup-step.active{display:block}
.step-num{font-family:var(--mono);font-size:10px;color:var(--a);letter-spacing:2px;margin-bottom:6px}
.step-title{font-size:20px;font-weight:700;margin-bottom:6px}
.step-sub{font-size:13px;color:var(--tx2);margin-bottom:20px;line-height:1.6}
.code-block{background:var(--bg);border:1px solid var(--b2);border-radius:8px;padding:14px;font-family:var(--mono);font-size:11px;color:var(--g);line-height:1.7;margin-bottom:16px;white-space:pre-wrap;word-break:break-all}
.step-input{width:100%;background:var(--bg);border:1px solid var(--b1);border-radius:8px;padding:11px 14px;color:var(--tx);font-family:var(--mono);font-size:12px;outline:none;margin-bottom:8px;transition:.15s}
.step-input:focus{border-color:var(--g)}
.step-actions{display:flex;gap:8px;margin-top:16px}
.sbtn{padding:11px 22px;border-radius:8px;border:none;font-family:var(--sans);font-size:13px;font-weight:700;cursor:pointer;transition:.15s}
.sbtn.p{background:var(--g);color:#080a0f}.sbtn.p:hover{opacity:.85}
.sbtn.s{background:transparent;border:1px solid var(--b2);color:var(--tx2)}.sbtn.s:hover{border-color:var(--tx);color:var(--tx)}
.ferr2{color:var(--r);font-family:var(--mono);font-size:10px;margin-top:6px;min-height:16px}
.chk-item{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:7px;background:var(--bg);border:1px solid var(--b1);margin-bottom:6px;font-size:12px;color:var(--tx2)}
.ck{width:14px;height:14px;border-radius:3px;border:1.5px solid var(--b2);display:flex;align-items:center;justify-content:center;font-size:9px;flex-shrink:0;background:var(--g);border-color:var(--g);color:#080a0f}

/* LOGIN */
#loginScreen{display:none;position:fixed;inset:0;z-index:999;background:var(--bg);align-items:center;justify-content:center;padding:20px}
#loginScreen.show{display:flex}
.login-card{background:var(--s1);border:1px solid var(--b1);border-radius:16px;padding:36px;width:100%;max-width:400px;box-shadow:var(--sh);animation:popIn .4s cubic-bezier(.34,1.56,.64,1)}
@keyframes popIn{from{opacity:0;transform:scale(.92)}to{opacity:1;transform:none}}
.llbl{font-family:var(--mono);font-size:9px;color:var(--tx3);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:5px}
.linput{width:100%;background:var(--bg);border:1px solid var(--b1);border-radius:7px;padding:11px 13px;color:var(--tx);font-family:var(--sans);font-size:14px;outline:none;margin-bottom:12px;transition:.15s}
.linput:focus{border-color:var(--g)}
.role-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:14px}
.role-btn{padding:10px;border-radius:7px;border:1px solid var(--b1);background:transparent;color:var(--tx2);font-family:var(--sans);font-size:12px;cursor:pointer;text-align:center;transition:.2s}
.role-btn:hover{border-color:var(--b2);color:var(--tx)}
.role-btn.sel{border-color:var(--g);color:var(--g);background:var(--g3)}
.login-btn{width:100%;padding:13px;background:var(--g);color:#080a0f;border:none;border-radius:8px;font-family:var(--sans);font-size:14px;font-weight:700;cursor:pointer;transition:.15s}
.login-btn:hover{opacity:.88}
.lerr{color:var(--r);font-size:12px;font-family:var(--mono);margin-top:8px;min-height:16px}

/* HEADER */
header{position:sticky;top:0;z-index:200;background:rgba(8,10,15,.95);backdrop-filter:blur(24px);border-bottom:1px solid var(--b1);display:flex;align-items:center;gap:10px;padding:0 18px;height:52px}
.h-logo{font-family:var(--mono);font-weight:700;font-size:12px;color:var(--g);letter-spacing:2px;flex-shrink:0}
.h-sep{width:1px;height:18px;background:var(--b1)}
.h-title{font-size:12px;font-weight:600;color:var(--tx2)}
.h-right{display:flex;align-items:center;gap:8px;margin-left:auto}
.sync-indicator{display:flex;align-items:center;gap:5px;font-family:var(--mono);font-size:9px;color:var(--tx3)}
.sdot{width:6px;height:6px;border-radius:50%;background:var(--g);animation:pulse 2s infinite}
.sdot.off{background:var(--r);animation:none}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.h-user{display:flex;align-items:center;gap:6px;background:var(--s2);border:1px solid var(--b1);border-radius:7px;padding:4px 10px;cursor:default}
.h-av{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:9px;font-weight:700;border:1px solid}
.h-nm{font-size:12px;font-weight:600}
.h-rl{font-family:var(--mono);font-size:9px;color:var(--tx3)}
.notif-btn{position:relative;background:var(--s2);border:1px solid var(--b1);border-radius:7px;padding:5px 9px;cursor:pointer;font-size:13px;transition:.15s}
.notif-btn:hover{border-color:var(--w)}
.nd{position:absolute;top:-3px;right:-3px;width:8px;height:8px;border-radius:50%;background:var(--r);border:2px solid var(--bg)}
.nd.hidden{display:none}
.logout-btn{background:transparent;border:1px solid var(--b2);border-radius:6px;padding:4px 9px;color:var(--tx2);font-family:var(--mono);font-size:9px;cursor:pointer;transition:.15s;text-transform:uppercase;letter-spacing:.5px}
.logout-btn:hover{border-color:var(--r);color:var(--r)}

/* APP */
.app{position:relative;z-index:1;max-width:1300px;margin:0 auto;padding:18px 14px}

/* STATS */
.stats{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:18px}
.stat{background:var(--s1);border:1px solid var(--b1);border-radius:var(--rad);padding:14px 15px;cursor:pointer;transition:.15s;position:relative;overflow:hidden}
.stat:hover{border-color:var(--b2);transform:translateY(-1px)}
.stat::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px}
.s0::after{background:var(--w)}.s1::after{background:var(--tx3)}.s2::after{background:var(--a)}.s3::after{background:var(--r)}.s4::after{background:var(--g)}
.stat-l{font-family:var(--mono);font-size:9px;color:var(--tx3);text-transform:uppercase;letter-spacing:1px;margin-bottom:5px}
.stat-v{font-family:var(--mono);font-size:26px;font-weight:700;line-height:1}
.s0 .stat-v{color:var(--w)}.s1 .stat-v{color:var(--tx2)}.s2 .stat-v{color:var(--a)}.s3 .stat-v{color:var(--r)}.s4 .stat-v{color:var(--g)}

/* ONLINE BAR */
.online-bar{display:flex;align-items:center;gap:6px;margin-bottom:14px;font-family:var(--mono);font-size:9px;color:var(--tx3);flex-wrap:wrap}
.ou-chip{display:flex;align-items:center;gap:4px;background:var(--s2);border:1px solid var(--b1);border-radius:10px;padding:3px 8px}
.ou-dot{width:5px;height:5px;border-radius:50%;background:var(--g);flex-shrink:0}

/* TABS */
.tabbar{display:flex;align-items:center;gap:8px;margin-bottom:14px}
.tabs{display:flex;gap:3px;background:var(--s1);border:1px solid var(--b1);border-radius:var(--rad);padding:3px;flex:1}
.tab{flex:1;padding:7px 8px;border-radius:6px;border:none;background:transparent;color:var(--tx2);font-family:var(--mono);font-size:9px;font-weight:700;letter-spacing:.5px;cursor:pointer;text-transform:uppercase;transition:.15s;white-space:nowrap}
.tab:hover{color:var(--tx)}.tab.active{background:var(--s2);color:var(--g);border:1px solid var(--b1)}
.panel{display:none;animation:fadeUp .2s ease}.panel.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:none}}

/* FILTER */
.frow{display:flex;align-items:center;gap:7px;margin-bottom:12px;flex-wrap:wrap}
.chips{display:flex;gap:5px;flex-wrap:wrap}
.chip{padding:4px 12px;border-radius:20px;border:1px solid var(--b1);background:transparent;color:var(--tx2);font-family:var(--mono);font-size:9px;font-weight:700;letter-spacing:.5px;cursor:pointer;text-transform:uppercase;transition:.15s}
.chip:hover{border-color:var(--b2);color:var(--tx)}
.chip.on{border-color:var(--g);color:var(--g);background:var(--g3)}
.chip.oD{border-color:var(--tx2);color:var(--tx2);background:rgba(126,143,168,.08)}
.chip.oP{border-color:var(--a);color:var(--a);background:var(--a2)}
.chip.oO{border-color:var(--r);color:var(--r);background:var(--r2)}
.chip.oS{border-color:var(--g);color:var(--g);background:var(--g3)}
.ssel{background:var(--s1);border:1px solid var(--b1);border-radius:6px;padding:6px 9px;color:var(--tx2);font-family:var(--mono);font-size:9px;outline:none;cursor:pointer}
.sbox{position:relative;margin-left:auto}
.sbox input{background:var(--s1);border:1px solid var(--b1);border-radius:6px;padding:6px 10px 6px 28px;color:var(--tx);font-family:var(--sans);font-size:12px;outline:none;width:200px;transition:.15s}
.sbox input:focus{border-color:var(--g)}
.sbox::before{content:'‚åï';position:absolute;left:9px;top:50%;transform:translateY(-50%);color:var(--tx3);font-size:14px;pointer-events:none}

/* SURAT CARD */
.scard{background:var(--s1);border:1px solid var(--b1);border-radius:var(--rad);padding:15px;margin-bottom:9px;position:relative;overflow:hidden;transition:.15s}
.scard:hover{border-color:var(--b2);background:var(--s2)}
.scard::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;border-radius:3px 0 0 3px}
.pH::before{background:var(--r)}.pM::before{background:var(--w)}.pL::before{background:var(--g)}
.sr1{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:7px}
.smeta{font-family:var(--mono);font-size:9px;color:var(--a);letter-spacing:.5px;margin-bottom:2px}
.stitle{font-size:13px;font-weight:700;line-height:1.35}
.sbadges{display:flex;gap:4px;flex-shrink:0;flex-wrap:wrap;align-items:flex-start}
.bdg{font-family:var(--mono);font-size:8px;font-weight:700;padding:2px 6px;border-radius:3px;border:1px solid;letter-spacing:.5px;text-transform:uppercase}
.bD{color:var(--tx2);border-color:var(--b2);background:rgba(126,143,168,.07)}
.bP{color:var(--a);border-color:rgba(77,158,255,.3);background:var(--a2)}
.bS{color:var(--g);border-color:rgba(0,229,160,.3);background:var(--g3)}
.bO{color:var(--r);border-color:rgba(255,77,109,.3);background:var(--r2);animation:bl 2s infinite}
.bH{color:var(--r);border-color:rgba(255,77,109,.25);background:var(--r2)}
.bMed{color:var(--w);border-color:rgba(255,179,71,.25);background:var(--w2)}
.bL{color:var(--g);border-color:rgba(0,229,160,.2);background:var(--g3)}
@keyframes bl{0%,100%{opacity:1}50%{opacity:.5}}
.sinfo{display:flex;gap:10px;flex-wrap:wrap;font-family:var(--mono);font-size:9px;color:var(--tx2);margin-bottom:7px}
.si{display:flex;align-items:center;gap:3px}
.si.ur{color:var(--r)}.si.wn{color:var(--w)}
.sdesc{font-size:11px;color:var(--tx2);line-height:1.5;padding:7px 10px;background:var(--bg);border-radius:5px;border-left:2px solid var(--b2);margin-bottom:7px}
.sacts{display:flex;gap:5px;margin-top:9px;flex-wrap:wrap}
.dchips{display:flex;flex-wrap:wrap;gap:4px;margin-top:5px}
.dchip{display:flex;align-items:center;gap:3px;background:var(--s2);border:1px solid var(--b1);border-radius:3px;padding:2px 7px;font-size:9px;font-family:var(--mono)}
.dd{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.dd.pn{background:var(--a)}.dd.dn{background:var(--g)}.dd.lt{background:var(--r)}
.cmt-prev{border-top:1px solid var(--b1);padding-top:7px;margin-top:5px;display:flex;align-items:center;gap:7px}
.cmt-bubble{background:var(--s2);border:1px solid var(--b1);border-radius:5px;padding:5px 9px;font-size:10px;color:var(--tx2);flex:1;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}

/* BTN */
.btn{padding:6px 12px;border-radius:5px;border:none;font-family:var(--mono);font-size:9px;font-weight:700;letter-spacing:.5px;cursor:pointer;text-transform:uppercase;transition:.15s;display:inline-flex;align-items:center;gap:3px}
.bsm{padding:4px 8px;font-size:8px}
.bpri{background:var(--g);color:#080a0f}.bpri:hover{opacity:.85}
.binfo{background:transparent;border:1px solid var(--a);color:var(--a)}.binfo:hover{background:var(--a);color:#fff}
.bwrn{background:transparent;border:1px solid var(--w);color:var(--w)}.bwrn:hover{background:var(--w);color:#080a0f}
.bdng{background:transparent;border:1px solid var(--r);color:var(--r)}.bdng:hover{background:var(--r);color:#fff}
.bgst{background:transparent;border:1px solid var(--b2);color:var(--tx2)}.bgst:hover{border-color:var(--tx);color:var(--tx)}
.bsuc{background:transparent;border:1px solid var(--g);color:var(--g)}.bsuc:hover{background:var(--g);color:#080a0f}
.bpur{background:transparent;border:1px solid var(--p);color:var(--p)}.bpur:hover{background:var(--p);color:#fff}

/* FORM */
.fbox{background:var(--s1);border:1px solid var(--b1);border-radius:var(--rad);padding:18px;margin-bottom:14px}
.fhead{font-family:var(--mono);font-size:9px;color:var(--g);text-transform:uppercase;letter-spacing:2px;margin-bottom:14px;display:flex;align-items:center;gap:6px}
.fhead::before{content:'//';color:var(--tx3)}
.fg{display:grid;gap:10px;margin-bottom:10px}
.fg2{grid-template-columns:1fr 1fr}.fg3{grid-template-columns:1fr 1fr 1fr}.fg4{grid-template-columns:repeat(4,1fr)}.fgf{grid-column:1/-1}
.fld{display:flex;flex-direction:column;gap:4px}
label{font-family:var(--mono);font-size:9px;color:var(--tx3);text-transform:uppercase;letter-spacing:1px}
.req{color:var(--r)}
input,select,textarea{background:var(--bg);border:1px solid var(--b1);border-radius:6px;padding:8px 11px;color:var(--tx);font-family:var(--sans);font-size:13px;transition:.15s;outline:none;width:100%}
input:focus,select:focus,textarea:focus{border-color:var(--g)}
input::placeholder{color:var(--tx3)}
select option{background:var(--s1)}
textarea{resize:vertical;min-height:60px;line-height:1.5}
.cc{font-family:var(--mono);font-size:9px;color:var(--tx3);text-align:right;margin-top:2px}
.fact{display:flex;gap:7px;align-items:center;margin-top:12px}
.ferr{color:var(--r);font-family:var(--mono);font-size:9px}

/* REMINDER */
.rem-card{background:var(--s1);border:1px solid var(--b1);border-radius:var(--rad);padding:12px 14px;margin-bottom:7px;display:flex;align-items:center;gap:10px;transition:.15s}
.rem-card:hover{border-color:var(--b2)}
.rind{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.rind.ov{background:var(--r);box-shadow:0 0 8px var(--r)}.rind.td{background:var(--w);box-shadow:0 0 6px var(--w)}.rind.sn{background:var(--a)}.rind.ok{background:var(--g)}
.rbody{flex:1;min-width:0}
.rtitle{font-size:12px;font-weight:600;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rmeta{font-family:var(--mono);font-size:9px;color:var(--tx2)}
.rdays{font-family:var(--mono);font-size:12px;font-weight:700;text-align:right;flex-shrink:0;min-width:80px}
.rdays.ov{color:var(--r)}.rdays.td{color:var(--w)}.rdays.sn{color:var(--a)}.rdays.ok{color:var(--g)}
.rdate{font-family:var(--mono);font-size:9px;color:var(--tx3);text-align:right;margin-top:2px}

/* ANGGOTA */
.angGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:10px}
.angCard{background:var(--s1);border:1px solid var(--b1);border-radius:var(--rad);padding:15px}
.angTop{display:flex;align-items:center;gap:9px;margin-bottom:10px}
.angAv{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:12px;font-weight:700;flex-shrink:0;border:1px solid}
.angName{font-weight:700;font-size:13px;margin-bottom:2px}
.angRole{font-family:var(--mono);font-size:9px;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px}
.angStats{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:8px}
.prog{background:var(--bg);border-radius:4px;height:4px;overflow:hidden;margin-bottom:8px}
.prog-f{height:100%;border-radius:4px;transition:.4s;background:var(--a)}
.prog-f.full{background:var(--g)}
.task-list{display:flex;flex-direction:column;gap:4px}
.task-i{display:flex;align-items:center;gap:6px;padding:6px 8px;background:var(--bg);border-radius:5px;border:1px solid var(--b1);font-size:10px}
.task-i.dn{opacity:.4}
.tcb{width:14px;height:14px;border-radius:3px;border:1.5px solid var(--b2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:8px;transition:.15s;background:transparent;flex-shrink:0}
.tcb.chk{background:var(--g);border-color:var(--g);color:#080a0f}
.tcb:hover{border-color:var(--g)}
.tlbl{flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tdl{font-family:var(--mono);font-size:9px;flex-shrink:0}

/* ACTIVITY */
.act-item{display:flex;gap:9px;padding:9px 11px;border-radius:7px;margin-bottom:5px;background:var(--s1);border:1px solid var(--b1);transition:.15s}
.act-item:hover{border-color:var(--b2)}
.act-av{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:9px;font-weight:700;flex-shrink:0;border:1px solid}
.act-body{flex:1;min-width:0}
.act-who{font-size:11px;font-weight:600;margin-bottom:2px}
.act-what{font-size:11px;color:var(--tx2);line-height:1.4}
.act-when{font-family:var(--mono);font-size:9px;color:var(--tx3);margin-top:2px}
.act-tag{font-family:var(--mono);font-size:8px;padding:1px 5px;border-radius:3px;border:1px solid;margin-right:4px}

/* COMMENT */
.cmt-item{background:var(--s1);border:1px solid var(--b1);border-radius:7px;padding:10px 12px;margin-bottom:7px}
.cmt-hdr{display:flex;align-items:center;gap:7px;margin-bottom:6px}
.cmt-av{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:8px;font-weight:700;flex-shrink:0;border:1px solid}
.cmt-info{flex:1}
.cmt-nm{font-size:11px;font-weight:700}
.cmt-tm{font-family:var(--mono);font-size:9px;color:var(--tx3)}
.cmt-txt{font-size:12px;line-height:1.5;color:var(--tx2)}
.cmt-del{background:transparent;border:none;cursor:pointer;color:var(--tx3);font-size:11px;padding:2px 4px;border-radius:3px}
.cmt-del:hover{color:var(--r)}
.cmt-row{display:flex;gap:7px;margin-top:10px}
.cmt-row input{flex:1;font-size:12px}

/* MODAL */
.ov{display:none;position:fixed;inset:0;z-index:400;background:rgba(0,0,0,.8);backdrop-filter:blur(8px);align-items:center;justify-content:center;padding:14px}
.ov.open{display:flex}
.modal{background:var(--s1);border:1px solid var(--b2);border-radius:12px;padding:22px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;box-shadow:var(--sh)}
.mlg{max-width:700px}
.mtitle{font-family:var(--mono);font-size:9px;color:var(--g);text-transform:uppercase;letter-spacing:2px;margin-bottom:16px;display:flex;align-items:center;gap:6px}
.mtitle::before{content:'//';color:var(--tx3)}
.mfoot{display:flex;gap:7px;justify-content:flex-end;margin-top:16px;padding-top:12px;border-top:1px solid var(--b1)}

/* NOTIF */
.ni{display:flex;align-items:flex-start;gap:9px;padding:9px 11px;border-radius:7px;background:var(--s2);border:1px solid var(--b1);margin-bottom:6px}
.ni-icon{font-size:15px;flex-shrink:0}
.ni-body{flex:1}
.ni-msg{font-size:12px;margin-bottom:2px}
.ni-time{font-family:var(--mono);font-size:9px;color:var(--tx3)}

/* SECTION */
.sec{font-family:var(--mono);font-size:9px;color:var(--tx3);text-transform:uppercase;letter-spacing:1px;padding:7px 0 8px;border-bottom:1px solid var(--b1);margin-bottom:11px;display:flex;align-items:center;justify-content:space-between}

/* TOAST */
.toast-wrap{position:fixed;bottom:18px;right:18px;z-index:600;display:flex;flex-direction:column;gap:6px;pointer-events:none}
.toast{background:var(--s2);border:1px solid var(--b2);border-radius:8px;padding:9px 12px;font-family:var(--mono);font-size:10px;max-width:300px;display:flex;align-items:center;gap:7px;pointer-events:auto;animation:tIn .2s ease;box-shadow:var(--sh)}
.toast.ts{border-left:3px solid var(--g)}.toast.te{border-left:3px solid var(--r)}
.toast.tw{border-left:3px solid var(--w)}.toast.ti{border-left:3px solid var(--a)}
.tclose{margin-left:auto;cursor:pointer;color:var(--tx3);padding:1px 4px}
.tclose:hover{color:var(--tx)}
@keyframes tIn{from{transform:translateX(110%);opacity:0}to{transform:none;opacity:1}}

/* EMPTY */
.empty{text-align:center;padding:50px 20px;color:var(--tx3);font-family:var(--mono);font-size:11px}
.empty-icon{font-size:32px;margin-bottom:10px;display:block}

/* RESPONSIVE */
@media(max-width:768px){.stats{grid-template-columns:repeat(3,1fr)}.fg3,.fg4{grid-template-columns:1fr 1fr}}
@media(max-width:480px){.stats{grid-template-columns:repeat(2,1fr)}.fg2,.fg3,.fg4{grid-template-columns:1fr}.angGrid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div id="loadingScreen"><div class="spinner"></div><div class="loading-txt">Memuat aplikasi...</div></div>

<!-- SETUP -->
<div id="setupScreen" style="display:none !important;">
  <div class="setup-card">
    <div class="setup-step active" id="step1">
      <div class="step-num">SETUP ¬∑ LANGKAH 1/3</div>
      <div class="step-title">Selamat Datang di KPB Surat Manager Tim</div>
      <div class="step-sub">Perlu Firebase Realtime Database (gratis) agar seluruh tim mengakses data yang sama. Setup cukup dilakukan sekali oleh Pak Salim.</div>
      <div class="chk-item"><div class="ck">‚úì</div>Gratis untuk penggunaan internal tim KPB</div>
      <div class="chk-item"><div class="ck">‚úì</div>Data cloud Google ‚Äî sinkron real-time</div>
      <div class="chk-item"><div class="ck">‚úì</div>Login per anggota, riwayat siapa edit apa</div>
      <div class="chk-item"><div class="ck">‚úì</div>Komentar &amp; diskusi langsung di setiap surat</div>
      <div class="step-actions">
        <button class="sbtn p" onclick="goStep(2)">Mulai Setup Firebase ‚Üí</button>
        <button class="sbtn s" onclick="useDemo()">Coba Demo (Tanpa Internet)</button>
      </div>
    </div>
    <div class="setup-step" id="step2">
      <div class="step-num">SETUP ¬∑ LANGKAH 2/3</div>
      <div class="step-title">Buat Firebase Project</div>
      <div class="step-sub">Buka link di bawah di tab baru, ikuti langkah-langkah, lalu kembali untuk paste konfigurasi.</div>
      <div class="code-block">1. Buka: console.firebase.google.com
2. Klik "Add project" ‚Üí nama: kpb-surat-tim
3. Nonaktifkan Analytics ‚Üí Create project
4. Sidebar kiri ‚Üí "Realtime Database"
5. "Create Database" ‚Üí Start in test mode ‚Üí Enable
6. Sidebar kiri ‚Üí ‚öô Project Settings
7. Scroll ke "Your apps" ‚Üí klik &lt;/&gt; (Web)
8. Register app: kpb-surat-web
9. Salin seluruh blok firebaseConfig yang muncul</div>
      <label class="llbl">Paste firebaseConfig di sini:</label>
      <textarea class="step-input" id="fbConfigInput" rows="9" placeholder='Contoh format:
{
  apiKey: "AIzaSy...",
  authDomain: "kpb-surat-tim.firebaseapp.com",
  databaseURL: "https://kpb-surat-tim-default-rtdb.firebaseio.com",
  projectId: "kpb-surat-tim",
  storageBucket: "kpb-surat-tim.appspot.com",
  messagingSenderId: "123456",
  appId: "1:123456:web:abcdef"
}'></textarea>
      <div class="ferr2" id="fbErr"></div>
      <div class="step-actions">
        <button class="sbtn p" onclick="validateFb()">Validasi &amp; Lanjut ‚Üí</button>
        <button class="sbtn s" onclick="goStep(1)">‚Üê Kembali</button>
      </div>
    </div>
    <div class="setup-step" id="step3">
      <div class="step-num">SETUP ¬∑ LANGKAH 3/3</div>
      <div class="step-title">‚úÖ Firebase Berhasil Dikonfigurasi!</div>
      <div class="step-sub">Satu langkah terakhir: atur Database Rules agar tim bisa akses.</div>
      <div class="code-block">Di Firebase Console ‚Üí Realtime Database ‚Üí Rules:

{
  "rules": {
    ".read": true,
    ".write": true
  }
}

Klik "Publish" untuk menyimpan.</div>
      <div id="testStatus" style="margin-bottom:12px;font-family:var(--mono);font-size:11px;color:var(--g)"></div>
      <div class="step-actions">
        <button class="sbtn p" onclick="finishSetup()">Buka Aplikasi ‚Üí</button>
      </div>
    </div>
  </div>
</div>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-card">
    <div style="font-family:var(--mono);font-size:10px;color:var(--g);letter-spacing:2px;margin-bottom:6px">KPB ¬∑ TECH SUPPORT</div>
    <div style="font-size:22px;font-weight:700;margin-bottom:4px">Surat Manager Tim</div>
    <div style="font-size:12px;color:var(--tx2);margin-bottom:24px">Masuk untuk akses data tim real-time</div>
    <label class="llbl">Nama Lengkap <span class="req">*</span></label>
    <input class="linput" id="lNama" placeholder="Nama Anda">
    <label class="llbl">Jabatan / Bidang</label>
    <input class="linput" id="lJabatan" placeholder="Instrument Eng, Rotating Tech...">
    <label class="llbl" style="margin-bottom:8px">Role di Sistem</label>
    <div class="role-grid">
      <button class="role-btn sel" data-r="Manager" onclick="selRole(this)">üëî Manager / PIC</button>
      <button class="role-btn" data-r="Engineer" onclick="selRole(this)">‚öô Engineer</button>
      <button class="role-btn" data-r="Technician" onclick="selRole(this)">üîß Technician</button>
      <button class="role-btn" data-r="Admin" onclick="selRole(this)">üìã Admin</button>
    </div>
    <button class="login-btn" onclick="doLogin()">Masuk ke Sistem ‚Üí</button>
    <div class="lerr" id="lErr"></div>
  </div>
</div>

<!-- MODALS -->
<div class="ov" id="ovDetail"><div class="modal mlg"><div class="mtitle">Detail Surat</div><div id="detailContent"></div><div class="mfoot"><button class="btn bgst" onclick="closeOv('ovDetail')">Tutup</button><button class="btn bwrn" id="detEditBtn">‚úè Edit</button><button class="btn binfo" id="detDispBtn">‚Üí Disposisi</button></div></div></div>

<div class="ov" id="ovEdit"><div class="modal mlg"><div class="mtitle">Edit Surat</div><input type="hidden" id="editId">
<div class="fg fgf"><div class="fld fgf"><label>Perihal / Judul <span class="req">*</span></label><input type="text" id="eJudul"></div></div>
<div class="fg fg3"><div class="fld"><label>Jenis</label><select id="eJenis"><option>Surat Kerja</option><option>Surat Complaint</option><option>Surat Peminjaman</option><option>Surat BFW</option><option>Surat Instruksi</option><option>Surat Lainnya</option></select></div><div class="fld"><label>Prioritas</label><select id="ePrioritas"><option value="HIGH">HIGH</option><option value="MEDIUM">MEDIUM</option><option value="LOW">LOW</option></select></div><div class="fld"><label>Status</label><select id="eStatus"><option value="DRAFT">DRAFT</option><option value="PROSES">PROSES</option><option value="SELESAI">SELESAI</option></select></div></div>
<div class="fg fg3"><div class="fld"><label>Target Selesai</label><input type="date" id="eDl"></div><div class="fld"><label>Ditujukan Kepada</label><input type="text" id="eKpd"></div><div class="fld"><label>PIC</label><input type="text" id="ePIC"></div></div>
<div class="fg"><div class="fld"><label>No. Referensi</label><input type="text" id="eRef"></div></div>
<div class="fld"><label>Deskripsi</label><textarea id="eDesc"></textarea></div>
<div class="fld" style="margin-top:9px"><label>Catatan Update</label><input type="text" id="eNote" placeholder="Apa yang berubah?"></div>
<div class="mfoot"><button class="btn bgst" onclick="closeOv('ovEdit')">Batal</button><button class="btn bpri" onclick="saveEdit()">üíæ Simpan</button></div></div></div>

<div class="ov" id="ovDisp"><div class="modal"><div class="mtitle">Disposisi Surat</div><div id="dispInfo" style="background:var(--bg);border-radius:6px;padding:9px 11px;margin-bottom:12px;font-size:11px;color:var(--tx2);border-left:3px solid var(--a)"></div><input type="hidden" id="dSuratId"><input type="hidden" id="dDispId">
<div class="fg fg2"><div class="fld"><label>Anggota <span class="req">*</span></label><select id="dAng"></select></div><div class="fld"><label>Deadline</label><input type="date" id="dDl"></div></div>
<div class="fld"><label>Instruksi</label><textarea id="dNote" rows="3" placeholder="Instruksi detail..."></textarea></div>
<div class="mfoot"><button class="btn bgst" onclick="closeOv('ovDisp')">Batal</button><button class="btn bpri" onclick="saveDisp()">üì§ Kirim</button></div></div></div>

<div class="ov" id="cfmOv"><div class="modal"><div class="mtitle" style="color:var(--r)">Konfirmasi Hapus</div><div id="cfmMsg" style="font-size:13px;color:var(--tx2)"></div><div style="font-size:9px;color:var(--r);font-family:var(--mono);margin-top:7px">‚ö† Tidak dapat dibatalkan</div><div class="mfoot"><button class="btn bgst" onclick="closeOv('cfmOv')">Batal</button><button class="btn bdng" id="cfmOkBtn">Ya, Hapus</button></div></div></div>

<div class="ov" id="ovNotif"><div class="modal"><div class="mtitle">üîî Notifikasi</div><div id="notifContent"></div><div class="mfoot"><button class="btn bgst" onclick="closeOv('ovNotif')">Tutup</button></div></div></div>

<div class="toast-wrap" id="tw"></div>

<!-- MAIN APP -->
<div id="mainApp" style="display:none">
  <header>
    <div class="h-logo">KPB<span style="color:var(--tx3);font-weight:400">_SM</span></div>
    <div class="h-sep"></div>
    <div class="h-title">Technical Support</div>
    <div class="h-right">
      <div class="sync-indicator"><div class="sdot" id="sdot"></div><span id="stxt">Terhubung</span></div>
      <button class="notif-btn" onclick="openOv('ovNotif');renderNotif()" title="Notifikasi">üîî<div class="nd hidden" id="nDot"></div></button>
      <div class="h-user"><div class="h-av" id="hAv"></div><div><div class="h-nm" id="hNm"></div><div class="h-rl" id="hRl"></div></div></div>
      <button class="logout-btn" onclick="doLogout()">Keluar</button>
    </div>
  </header>
  <div class="app">
    <div class="stats">
      <div class="stat s0" onclick="setFilter('ALL')"><div class="stat-l">Total</div><div class="stat-v" id="sv0">0</div></div>
      <div class="stat s1" onclick="setFilter('DRAFT')"><div class="stat-l">Draft</div><div class="stat-v" id="sv1">0</div></div>
      <div class="stat s2" onclick="setFilter('PROSES')"><div class="stat-l">Proses</div><div class="stat-v" id="sv2">0</div></div>
      <div class="stat s3" onclick="setFilter('OVERDUE')"><div class="stat-l">Overdue</div><div class="stat-v" id="sv3">0</div></div>
      <div class="stat s4" onclick="setFilter('SELESAI')"><div class="stat-l">Selesai</div><div class="stat-v" id="sv4">0</div></div>
    </div>
    <div class="online-bar" id="onlineBar"></div>
    <div class="tabbar">
      <div class="tabs">
        <button class="tab active" id="tab-daftar" onclick="showPanel('daftar')">üìã Daftar</button>
        <button class="tab" id="tab-tambah" onclick="showPanel('tambah')">‚úö Tambah</button>
        <button class="tab" id="tab-reminder" onclick="showPanel('reminder')">‚è∞ Reminder</button>
        <button class="tab" id="tab-disp" onclick="showPanel('disp')">üë• Disposisi</button>
        <button class="tab" id="tab-activity" onclick="showPanel('activity')">üìú Aktivitas</button>
        <button class="tab" id="tab-anggota" onclick="showPanel('anggota')">‚öô Anggota</button>
      </div>
      
    </div>

    <div class="panel active" id="panel-daftar">
      <div class="frow">
        <div class="chips" id="filterChips">
          <button class="chip on" data-f="ALL" onclick="setFilter('ALL',this)">Semua</button>
          <button class="chip" data-f="DRAFT" onclick="setFilter('DRAFT',this)">Draft</button>
          <button class="chip" data-f="PROSES" onclick="setFilter('PROSES',this)">Proses</button>
          <button class="chip" data-f="OVERDUE" onclick="setFilter('OVERDUE',this)">Overdue</button>
          <button class="chip" data-f="SELESAI" onclick="setFilter('SELESAI',this)">Selesai</button>
        </div>
        <select class="ssel" id="sortSel" onchange="renderList()">
          <option value="dl-asc">Deadline ‚Üë</option><option value="dl-desc">Deadline ‚Üì</option>
          <option value="pri">Prioritas</option><option value="new">Terbaru</option><option value="st">Status</option>
        </select>
        <div class="sbox"><input type="text" id="srch" placeholder="Cari..." oninput="renderList()"></div>
      </div>
      <div id="suratList"></div>
    </div>

    <div class="panel" id="panel-tambah">
      <div class="fbox"><div class="fhead">Tambah Surat Baru</div>
        <div class="fg"><div class="fld fgf"><label>Perihal / Judul <span class="req">*</span></label><input type="text" id="iJudul" placeholder="Perihal surat..." maxlength="200" oninput="cc('iJudul','ccj',200)"><div class="cc" id="ccj">0/200</div></div></div>
        <div class="fg fg4"><div class="fld"><label>Jenis</label><select id="iJenis"><option>Surat Kerja</option><option>Surat Complaint</option><option>Surat Peminjaman</option><option>Surat BFW</option><option>Surat Instruksi</option><option>Surat Lainnya</option></select></div><div class="fld"><label>Prioritas</label><select id="iPrio"><option value="HIGH">HIGH</option><option value="MEDIUM" selected>MEDIUM</option><option value="LOW">LOW</option></select></div><div class="fld"><label>Target Selesai</label><input type="date" id="iDl"></div><div class="fld"><label>No. Referensi</label><input type="text" id="iRef" placeholder="OV-0162A..."></div></div>
        <div class="fg fg2"><div class="fld"><label>Ditujukan Kepada</label><input type="text" id="iKpd" placeholder="Nama/Jabatan/Dept"></div><div class="fld"><label>PIC / Pembuat</label><input type="text" id="iPIC"></div></div>
        <div class="fld"><label>Deskripsi</label><textarea id="iDesc" placeholder="Isi singkat / catatan penting..." maxlength="1000" oninput="cc('iDesc','ccd',1000)"></textarea><div class="cc" id="ccd">0/1000</div></div>
        <div class="fact"><button class="btn bpri" onclick="tambahSurat()">‚úö Simpan Surat</button><button class="btn bgst" onclick="clearForm()">‚Ü∫ Reset</button><span id="tambahErr" class="ferr"></span></div>
      </div>
    </div>

    <div class="panel" id="panel-reminder"><div class="sec"><span>‚è∞ Monitor Deadline</span><span id="remCnt" style="color:var(--tx3)"></span></div><div id="reminderList"></div></div>
    <div class="panel" id="panel-disp"><div class="sec"><span>üë• Tracker Disposisi</span><button class="btn bsm bgst" onclick="renderDispPanel()">‚Ü∫</button></div><div id="dispTracker"></div></div>
    <div class="panel" id="panel-activity"><div class="sec"><span>üìú Log Aktivitas Tim</span><span id="actCnt" style="color:var(--tx3)"></span></div><div id="activityFeed"></div></div>
    <div class="panel" id="panel-anggota">
      <div class="fbox"><div class="fhead">Kelola Anggota Tim</div>
        <div class="fg fg3"><div class="fld"><label>Nama <span class="req">*</span></label><input type="text" id="iNama" placeholder="Nama lengkap"></div><div class="fld"><label>Jabatan</label><input type="text" id="iJabatan" placeholder="Instrument Eng..."></div><div class="fld"><label>Kontak</label><input type="text" id="iKontak" placeholder="ext / HP"></div></div>
        <div class="fact"><button class="btn bpri" onclick="tambahAnggota()">‚úö Tambah</button><span id="angErr" class="ferr"></span></div>
      </div>
      <div class="angGrid" id="angGrid"></div>
    </div>
  </div>
</div>

<script>
'use strict';
const CFG_KEY='kpb_fb_cfg_v2',USER_KEY='kpb_user_v2',DEMO_KEY='kpb_demo_v2';
let db=null,isDemo=false,currentUser=null,activeFilter='ALL',pendingDel=null,selR='Engineer TS';
let pendingFile=null;

// PERMISSION SYSTEM - OPSI B
function canDo(action,surat){
if(!currentUser)return false;
const r=currentUser.sysRole;
if(r==='Manager')return true;
if(action==='add')return r==='Engineer TS'||r==='Sekretaris TS';
if(action==='edit'){if(r==='Sekretaris TS')return true;if(!surat)return false;return surat.createdBy===currentUser.nama||surat.disposisiKe===currentUser.id;}
if(action==='delete')return false;
if(action==='upload')return true;
if(action==='poffice')return r==='Sekretaris TS';
if(action==='anggota')return false;
return false;
}
function getStatusOpts(cur){
if(!currentUser)return[];
const r=currentUser.sysRole;
const all=['DISPOSISI','DIKERJAKAN','DRAFT_SELESAI','SIAP_POFFICE','DI_POFFICE','BATAL'];
if(r==='Manager')return all;
if(r==='Sekretaris TS'){if(cur==='SIAP_POFFICE')return['SIAP_POFFICE','DI_POFFICE','BATAL'];return[cur,'BATAL'];}
return all.filter(s=>s!=='SIAP_POFFICE'&&s!=='DI_POFFICE');
}
let D={surat:{},anggota:{},disposisi:{},activity:{}};

const gid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,6);
const tod=()=>new Date().toISOString().slice(0,10);
const fmtD=d=>{if(!d)return'-';try{return new Date(d).toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'});}catch(e){return d;}};
const fmtDT=ts=>{if(!ts)return'';try{const x=new Date(ts);return x.toLocaleDateString('id-ID',{day:'2-digit',month:'short'})+' '+x.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'});}catch(e){return'';}};
const dLeft=dl=>{const t=new Date();t.setHours(0,0,0,0);const d=new Date(dl);d.setHours(0,0,0,0);return Math.round((d-t)/86400000);};
const esc=s=>{if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');};
const getCS=s=>{if(s.status==='SELESAI')return'SELESAI';if(s.deadline&&dLeft(s.deadline)<0)return'OVERDUE';return s.status;};
const AVC=['var(--g)','var(--a)','var(--w)','var(--r)','var(--p)'];
const avC=n=>{let h=0;for(let i=0;i<n.length;i++)h+=n.charCodeAt(i);return AVC[h%AVC.length];};
const inits=n=>(n||'?').split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();

// SETUP
function goStep(n){document.querySelectorAll('.setup-step').forEach(s=>s.classList.remove('active'));document.getElementById('step'+n).classList.add('active');}

function validateFb(){
  const raw=document.getElementById('fbConfigInput').value.trim();
  const e=document.getElementById('fbErr');
  if(!raw){e.textContent='‚ö† Paste konfigurasi Firebase Anda';return;}
  try{
    let js=raw;
    if(!raw.startsWith('{'))js=(raw.match(/\{[\s\S]+\}/)||[raw])[0];
    js=js.replace(/([{,]\s*)([a-zA-Z_$][a-zA-Z0-9_$]*)\s*:/g,'$1"$2":');
    const cfg=JSON.parse(js);
    if(!cfg.apiKey||!cfg.projectId){e.textContent='‚ö† Tidak lengkap ‚Äî butuh apiKey & projectId';return;}
    if(!cfg.databaseURL)cfg.databaseURL='https://'+cfg.projectId+'-default-rtdb.firebaseio.com';
    localStorage.setItem(CFG_KEY,JSON.stringify(cfg));
    e.textContent='';
    tryConnect(cfg,true);
  }catch(err){e.textContent='‚ö† Format error: '+err.message;}
}

function tryConnect(cfg,fromSetup){
  if(fromSetup)goStep(3);
  try{
    if(firebase.apps.length)firebase.apps[0].delete();
    firebase.initializeApp(cfg);
    db=firebase.database();
    if(fromSetup){
      const el=document.getElementById('testStatus');
      db.ref('.info/connected').once('value',s=>{
        if(el)el.textContent=s.val()?'‚úÖ Koneksi berhasil! Siap digunakan.':'‚ö† Tidak terhubung ‚Äî periksa databaseURL dan rules.';
      });
    }
    return true;
  }catch(err){if(fromSetup&&document.getElementById('fbErr'))document.getElementById('fbErr').textContent='‚ùå '+err.message;return false;}
}

function finishSetup(){document.getElementById('setupScreen').classList.remove('show');showLogin();}

function useDemo(){
  isDemo=true;localStorage.setItem(DEMO_KEY,'1');
  document.getElementById('setupScreen').classList.remove('show');
  seedDemo();showLogin();
}

function seedDemo(){
  const d=n=>{const x=new Date();x.setDate(x.getDate()+n);return x.toISOString().slice(0,10);};
  const a1=gid(),a2=gid(),a3=gid(),a4=gid();
  D.anggota[a1]={id:a1,nama:'Ahmad Rizky',jabatan:'Instrument Engineer',kontak:'ext 1201'};
  D.anggota[a2]={id:a2,nama:'Budi Santoso',jabatan:'Rotating Equip Tech',kontak:'ext 1202'};
  D.anggota[a3]={id:a3,nama:'Candra Wijaya',jabatan:'Process Engineer',kontak:'ext 1203'};
  D.anggota[a4]={id:a4,nama:'Dewi Rahmawati',jabatan:'Document Control',kontak:'ext 1204'};
  const ids=[gid(),gid(),gid(),gid(),gid(),gid()];
  const srt=(i,j,p,s,dl,kpd,ref,desc)=>({id:i,judul:j,jenis:p,prioritas:s,status:'DRAFT',deadline:dl,kepada:kpd,pic:'Salim',ref:ref,desc:desc,createdAt:tod(),createdBy:'Salim',history:[{status:'DRAFT',note:'Dibuat',at:tod(),by:'Salim'}]});
  D.surat[ids[0]]=srt(ids[0],'Kegagalan Globe Valve Line LG','Surat Kerja','HIGH',d(2),'Manager Operasi','Globe Valve - LG','Laporan kegagalan globe valve. Perlu analisa root cause segera.');
  D.surat[ids[1]]=srt(ids[1],'Complaint Leak Boiler A','Surat Complaint','HIGH',d(1),'Kontraktor Boiler','Boiler A','Komplain leak Boiler A. Minta perbaikan segera sesuai kontrak.');
  D.surat[ids[2]]={...srt(ids[2],'BFW-D ‚Äî Instrument dan Rotating','Surat BFW','MEDIUM',d(5),'Dept Instrument & Rotating','BFW-D','Koordinasi kesiapan BFW-D untuk komisioning.'),status:'PROSES',history:[{status:'DRAFT',note:'Dibuat',at:tod(),by:'Salim'},{status:'PROSES',note:'Diserahkan ke dept',at:tod(),by:'Salim'}]};
  D.surat[ids[3]]=srt(ids[3],'Balik SWPO Complaint','Surat Complaint','MEDIUM',d(4),'SWPO / Vendor','SWPO','Surat balasan atas complaint SWPO.');
  D.surat[ids[4]]=srt(ids[4],'Peminjaman OV-0162A ‚Äî Valve dibebaskan','Surat Peminjaman','HIGH',d(0),'Dept Asset Owner','OV-0162A','Peminjaman valve OV-0162A untuk komisioning RFCC.');
  D.surat[ids[5]]=srt(ids[5],'Peminjaman ‚Äî Modifikasi Line Hopper','Surat Peminjaman','MEDIUM',d(6),'Dept Terkait','Line Hopper','Peminjaman terkait modifikasi line hopper.');
  const did=gid();
  D.disposisi[did]={id:did,suratId:ids[2],anggotaId:a1,note:'Koordinasi readiness instrument BFW-D',deadline:d(4),createdAt:tod(),createdBy:'Salim',done:false};
}

// LOGIN
function showLogin(){
  document.getElementById('loadingScreen').classList.add('hidden');
  const ls=document.getElementById('loginScreen');
  ls.classList.add('show');ls.style.display='';
  const sv=JSON.parse(localStorage.getItem(USER_KEY)||'null');
  if(sv){document.getElementById('lNama').value=sv.nama||'';document.getElementById('lJabatan').value=sv.jabatan||'';selR=sv.sysRole||'Manager';document.querySelectorAll('.role-btn').forEach(b=>b.classList.toggle('sel',b.dataset.r===selR));}
}

function selRole(btn){selR=btn.dataset.r;document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('sel'));btn.classList.add('sel');}

function doLogin(){
  const nama=document.getElementById('lNama').value.trim();
  if(!nama){document.getElementById('lErr').textContent='‚ö† Nama wajib diisi';return;}
  currentUser={id:gid(),nama,jabatan:document.getElementById('lJabatan').value.trim(),sysRole:selR,loginAt:new Date().toISOString()};
  localStorage.setItem(USER_KEY,JSON.stringify(currentUser));
  document.getElementById('loginScreen').classList.remove('show');
  document.getElementById('loginScreen').style.display='none';
  startApp();
}

function doLogout(){
  if(!confirm('Keluar?'))return;
  if(!isDemo&&db)db.ref('online/'+currentUser.id).remove();
  document.getElementById('mainApp').style.display='none';
  const ls=document.getElementById('loginScreen');ls.classList.add('show');ls.style.display='';
}

// START APP
function startApp(){
  // Hide tabs based on role
  if(!canDo('add')){
    const tabTambah=document.getElementById('tab-tambah');
    if(tabTambah)tabTambah.style.display='none';
  }
  if(!canDo('anggota')){
    const tabAnggota=document.getElementById('tab-anggota');
    if(tabAnggota)tabAnggota.style.display='none';
  }
  const ma=document.getElementById('mainApp');ma.style.display='block';
  const col=avC(currentUser.nama);
  const av=document.getElementById('hAv');
  av.textContent=inits(currentUser.nama);av.style.color=col;av.style.borderColor=col;av.style.background=col+'22';
  document.getElementById('hNm').textContent=currentUser.nama;
  document.getElementById('hRl').textContent=currentUser.sysRole;
  document.getElementById('iPIC').value=currentUser.nama;

  if(isDemo){setSyncSt(true,'Demo Mode');onChanged();showToast('Mode Demo ‚Äî data tidak disimpan ke cloud','info');return;}

  db.ref('.info/connected').on('value',s=>setSyncSt(s.val()===true));
  ['surat','anggota','disposisi','activity'].forEach(k=>{
    db.ref(k).on('value',snap=>{D[k]=snap.val()||{};onChanged();});
  });
  db.ref('online/'+currentUser.id).set({nama:currentUser.nama,jabatan:currentUser.jabatan,ts:new Date().toISOString()});
  db.ref('online/'+currentUser.id).onDisconnect().remove();
  db.ref('online').on('value',snap=>{
    const u=snap.val()||{};
    const bar=document.getElementById('onlineBar');
    const list=Object.values(u);
    bar.innerHTML='<span>üü¢ Online:</span>'+list.map(x=>'<div class="ou-chip"><div class="ou-dot"></div>'+esc(x.nama)+'</div>').join('');
  });
  logAct('LOGIN','','');
}

function setSyncSt(ok,lbl){const d=document.getElementById('sdot'),t=document.getElementById('stxt');d.classList.toggle('off',!ok);t.textContent=lbl||(ok?'Terhubung':'Offline');}

function onChanged(){
  updateStats();
  if(document.getElementById('panel-daftar').classList.contains('active'))renderList();
  if(document.getElementById('panel-reminder').classList.contains('active'))renderReminder();
  if(document.getElementById('panel-disp').classList.contains('active'))renderDispPanel();
  if(document.getElementById('panel-activity').classList.contains('active'))renderActivity();
  if(document.getElementById('panel-anggota').classList.contains('active'))renderAngGrid();
}

// DB OPS
function dbW(path,data){
  if(isDemo){const p=path.split('/').filter(Boolean);let o=D;for(let i=0;i<p.length-1;i++){if(!o[p[i]])o[p[i]]={};o=o[p[i]];}o[p[p.length-1]]=data;onChanged();return;}
  db.ref(path).set(data);
}
function dbR(path){
  if(isDemo){const p=path.split('/').filter(Boolean);let o=D;for(let i=0;i<p.length-1;i++)o=(o[p[i]]||{});delete o[p[p.length-1]];onChanged();return;}
  db.ref(path).remove();
}
function logAct(action,suratJudul,extra){
  if(!currentUser)return;
  const e={id:gid(),userId:currentUser.id,userName:currentUser.nama,userRole:currentUser.sysRole,action,suratJudul:suratJudul||'',extra:extra||'',ts:new Date().toISOString()};
  if(isDemo){D.activity[e.id]=e;onChanged();return;}
  db.ref('activity/'+e.id).set(e);
}

// STATS
function updateStats(){
  const all=Object.values(D.surat||{});
  const cs=all.map(s=>getCS(s));
  document.getElementById('sv0').textContent=all.length;
  document.getElementById('sv1').textContent=cs.filter(s=>s==='DRAFT').length;
  document.getElementById('sv2').textContent=cs.filter(s=>s==='PROSES').length;
  document.getElementById('sv3').textContent=cs.filter(s=>s==='OVERDUE').length;
  document.getElementById('sv4').textContent=cs.filter(s=>s==='SELESAI').length;
  const urg=cs.filter(s=>s==='OVERDUE').length+all.filter(s=>s.status!=='SELESAI'&&s.deadline&&dLeft(s.deadline)===0).length;
  document.getElementById('nDot').classList.toggle('hidden',urg===0);
}

// PANELS
function showPanel(n){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('panel-'+n).classList.add('active');
  document.getElementById('tab-'+n).classList.add('active');
  if(n==='daftar')renderList();
  if(n==='reminder')renderReminder();
  if(n==='disp')renderDispPanel();
  if(n==='activity')renderActivity();
  if(n==='anggota')renderAngGrid();
}

// FILTER & LIST
function setFilter(f,btn){
  activeFilter=f;
  document.querySelectorAll('#filterChips .chip').forEach(c=>{c.classList.remove('on','oD','oP','oO','oS');});
  const cls={ALL:'on',DRAFT:'oD',PROSES:'oP',OVERDUE:'oO',SELESAI:'oS'};
  if(btn)btn.classList.add(cls[f]||'on');
  else{const c=document.querySelector('#filterChips [data-f="'+f+'"]');if(c)c.classList.add(cls[f]||'on');}
  showPanel('daftar');
}

function renderList(){
  const cont=document.getElementById('suratList');
  const q=(document.getElementById('srch').value||'').toLowerCase().trim();
  const sort=document.getElementById('sortSel').value;
  let items=Object.values(D.surat||{}).map(s=>({...s,_cs:getCS(s)}));
  if(activeFilter!=='ALL')items=items.filter(s=>s._cs===activeFilter);
  if(q)items=items.filter(s=>(s.judul||'').toLowerCase().includes(q)||(s.ref||'').toLowerCase().includes(q)||(s.kepada||'').toLowerCase().includes(q)||(s.desc||'').toLowerCase().includes(q)||(s.pic||'').toLowerCase().includes(q));
  const po={HIGH:0,MEDIUM:1,LOW:2},so={OVERDUE:0,DRAFT:1,PROSES:2,SELESAI:3};
  if(sort==='dl-asc')items.sort((a,b)=>(a.deadline||'9')>(b.deadline||'9')?1:-1);
  else if(sort==='dl-desc')items.sort((a,b)=>(a.deadline||'0')<(b.deadline||'0')?1:-1);
  else if(sort==='pri')items.sort((a,b)=>po[a.prioritas]-po[b.prioritas]);
  else if(sort==='new')items.sort((a,b)=>b.createdAt>a.createdAt?1:-1);
  else if(sort==='st')items.sort((a,b)=>so[a._cs]-so[b._cs]);

  if(!items.length){cont.innerHTML='<div class="empty"><span class="empty-icon">üì≠</span>'+(q?'Tidak ada hasil: "'+esc(q)+'"':'Tidak ada surat')+' </div>';updateStats();return;}

  cont.innerHTML=items.map(s=>{
    const cs=s._cs,dl=s.deadline?dLeft(s.deadline):null;
    let dlTxt='',dlCls='';
    if(dl!==null){if(dl<0){dlTxt='‚ö† '+Math.abs(dl)+'h terlambat';dlCls='ur';}else if(dl===0){dlTxt='‚ö° Hari ini!';dlCls='wn';}else if(dl<=3){dlTxt=dl+'h lagi';dlCls='wn';}else dlTxt=dl+'h lagi';}
    const disps=Object.values(D.disposisi||{}).filter(d=>d.suratId===s.id);
    const cmts=Object.values(D.activity||{}).filter(a=>a.action==='KOMENTAR'&&a.suratId===s.id);
    const lc=cmts.sort((a,b)=>b.ts>a.ts?1:-1)[0];
    const clsMap={HIGH:'pH',MEDIUM:'pM',LOW:'pL'};
    const bdCS={DRAFT:'bD',PROSES:'bP',SELESAI:'bS',OVERDUE:'bO'};
    const bdPri={HIGH:'bH',MEDIUM:'bMed',LOW:'bL'};

    return '<div class="scard '+clsMap[s.prioritas]+'">'+
      '<div class="sr1">'+
        '<div style="flex:1;min-width:0">'+
          '<div class="smeta">'+esc(s.jenis)+(s.ref?' ¬∑ '+esc(s.ref):'')+'</div>'+
          '<div class="stitle">'+esc(s.judul)+'</div>'+
        '</div>'+
        '<div class="sbadges">'+
          '<span class="bdg '+bdPri[s.prioritas]+'">'+s.prioritas+'</span>'+
          '<span class="bdg '+bdCS[cs]+'">'+cs+'</span>'+
        '</div>'+
      '</div>'+
      '<div class="sinfo">'+
        (s.kepada?'<span class="si">üë§ '+esc(s.kepada)+'</span>':'')+
        (s.pic?'<span class="si">üîß '+esc(s.pic)+'</span>':'')+
        (s.deadline?'<span class="si '+dlCls+'">üìÖ '+fmtD(s.deadline)+' ‚Äî '+dlTxt+'</span>':'')+
        '<span class="si" style="color:var(--tx3)">oleh '+esc(s.createdBy||s.pic||'-')+'</span>'+
      '</div>'+
      (s.desc?'<div class="sdesc">'+esc(s.desc)+'</div>':'')+
      (disps.length?'<div style="font-family:var(--mono);font-size:9px;color:var(--tx3);margin-bottom:4px">Disposisi ('+disps.length+'):</div><div class="dchips">'+disps.map(d=>{const a=Object.values(D.anggota||{}).find(x=>x.id===d.anggotaId);const dc=d.done?'dn':(d.deadline&&dLeft(d.deadline)<0?'lt':'pn');return '<div class="dchip"><div class="dd '+dc+'"></div>'+(a?esc(a.nama):'?')+(d.done?' ‚úì':'')+'</div>';}).join('')+'</div>':'')+
      (lc?'<div class="cmt-prev"><div class="cmt-bubble"><strong>'+esc(lc.userName)+':</strong> '+esc(lc.extra)+'</div><span style="font-family:var(--mono);font-size:9px;color:var(--tx3);flex-shrink:0">'+fmtDT(lc.ts)+'</span></div>':'')+
      '<div class="sacts">'+
        '<button class="btn bsm bgst" onclick="openDetail(\''+s.id+'\')">üîç Detail</button>'+
        '<button class="btn bsm bwrn" onclick="openEdit(\''+s.id+'\')">‚úè Edit</button>'+
        '<button class="btn bsm binfo" onclick="openDisp(\''+s.id+'\')">‚Üí Disp</button>'+
        '<button class="btn bsm bpur" onclick="openKmt(\''+s.id+'\')">üí¨'+(cmts.length?' '+cmts.length:'')+'</button>'+
        (cs!=='SELESAI'?'<button class="btn bsm bsuc" onclick="qSelesai(\''+s.id+'\')">‚úì Selesai</button>':'')+
        '<button class="btn bsm bdng" onclick="cfmHapusSurat(\''+s.id+'\')">‚úï</button>'+
      '</div></div>';
  }).join('');
  updateStats();
}

// DETAIL
function openDetail(id){
  const s=Object.values(D.surat||{}).find(x=>x.id===id);if(!s)return;
  const cs=getCS(s),disps=Object.values(D.disposisi||{}).filter(d=>d.suratId===id);
  const hist=s.history||[],dl=s.deadline?dLeft(s.deadline):null;
  let dlTxt='';if(dl!==null){if(dl<0)dlTxt='<span style="color:var(--r)">‚ö† '+Math.abs(dl)+'h terlambat</span>';else if(dl===0)dlTxt='<span style="color:var(--w)">‚ö° Hari ini!</span>';else dlTxt='<span style="color:var(--g)">'+dl+' hari lagi</span>';}
  const cmts=Object.values(D.activity||{}).filter(a=>a.action==='KOMENTAR'&&a.suratId===id).sort((a,b)=>a.ts>b.ts?1:-1);
  const bdCS={DRAFT:'bD',PROSES:'bP',SELESAI:'bS',OVERDUE:'bO'},bdPri={HIGH:'bH',MEDIUM:'bMed',LOW:'bL'};

  document.getElementById('detailContent').innerHTML=
    '<div style="display:flex;gap:5px;margin-bottom:12px;flex-wrap:wrap">'+
      '<span class="bdg '+bdPri[s.prioritas]+'">'+s.prioritas+'</span>'+
      '<span class="bdg '+bdCS[cs]+'">'+cs+'</span>'+
      '<span class="bdg bP">'+esc(s.jenis)+'</span>'+
    '</div>'+
    '<div style="font-size:16px;font-weight:700;margin-bottom:12px;line-height:1.4">'+esc(s.judul)+'</div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">'+
      '<div><div style="font-family:var(--mono);font-size:9px;color:var(--tx3);margin-bottom:3px">KEPADA</div><div style="font-size:12px">'+esc(s.kepada||'-')+'</div></div>'+
      '<div><div style="font-family:var(--mono);font-size:9px;color:var(--tx3);margin-bottom:3px">PIC</div><div style="font-size:12px">'+esc(s.pic||'-')+'</div></div>'+
      '<div><div style="font-family:var(--mono);font-size:9px;color:var(--tx3);margin-bottom:3px">REF</div><div style="font-size:12px">'+esc(s.ref||'-')+'</div></div>'+
      '<div><div style="font-family:var(--mono);font-size:9px;color:var(--tx3);margin-bottom:3px">DEADLINE</div><div style="font-size:12px">'+(s.deadline?fmtD(s.deadline)+' ‚Äî '+dlTxt:'-')+'</div></div>'+
    '</div>'+
    (s.desc?'<div style="background:var(--bg);padding:9px 11px;border-radius:6px;border-left:3px solid var(--b2);font-size:11px;color:var(--tx2);line-height:1.55;margin-bottom:12px">'+esc(s.desc)+'</div>':'')+
    (disps.length?'<div style="margin-bottom:12px"><div style="font-family:var(--mono);font-size:9px;color:var(--tx3);margin-bottom:6px">DISPOSISI ('+disps.length+')</div>'+disps.map(d=>{const a=Object.values(D.anggota||{}).find(x=>x.id===d.anggotaId);const dc=d.done?'dn':(d.deadline&&dLeft(d.deadline)<0?'lt':'pn');return '<div style="display:flex;align-items:center;gap:7px;padding:7px 9px;background:var(--bg);border-radius:5px;border:1px solid var(--b1);margin-bottom:4px"><div class="dd '+dc+'" style="width:7px;height:7px;border-radius:50%;flex-shrink:0"></div><div style="flex:1"><div style="font-size:11px;font-weight:600">'+(a?esc(a.nama):'?')+'</div>'+(d.note?'<div style="font-size:10px;color:var(--tx2)">'+esc(d.note)+'</div>':'')+'</div>'+(d.deadline?'<div style="font-family:var(--mono);font-size:9px;color:var(--tx3)">'+fmtD(d.deadline)+'</div>':'')+'<span class="bdg '+(d.done?'bS':'bP')+'" style="font-size:8px">'+(d.done?'‚úì':'Aktif')+'</span></div>';}).join('')+'</div>':'')+
    '<div style="margin-bottom:12px">'+
      '<div style="font-family:var(--mono);font-size:9px;color:var(--tx3);margin-bottom:7px">üí¨ KOMENTAR ('+cmts.length+')</div>'+
      (cmts.length?cmts.map(c=>{const col=avC(c.userName);return '<div class="cmt-item"><div class="cmt-hdr"><div class="cmt-av" style="background:'+col+'22;border-color:'+col+';color:'+col+'">'+inits(c.userName)+'</div><div class="cmt-info"><div class="cmt-nm">'+esc(c.userName)+' <span style="font-size:9px;color:var(--tx3);font-family:var(--mono)">'+c.userRole+'</span></div><div class="cmt-tm">'+fmtDT(c.ts)+'</div></div>'+(c.userName===currentUser.nama?'<button class="cmt-del" onclick="delCmt(\''+c.id+'\',\''+id+'\')" title="Hapus komentar">‚úï</button>':'')+'</div><div class="cmt-txt">'+esc(c.extra)+'</div></div>';}).join(''):'')+
      '<div class="cmt-row"><input type="text" id="cmtI-'+id+'" placeholder="Tulis komentar..." onkeydown="if(event.key===\'Enter\')sendCmt(\''+id+'\')"><button class="btn bsm bpri" onclick="sendCmt(\''+id+'\')">Kirim</button></div>'+
    '</div>'+
    (hist.length?'<div><div style="font-family:var(--mono);font-size:9px;color:var(--tx3);margin-bottom:6px">üìã RIWAYAT STATUS</div>'+hist.slice().reverse().map(h=>'<div style="display:flex;gap:7px;margin-bottom:4px"><div style="width:6px;height:6px;border-radius:50%;background:var(--g);flex-shrink:0;margin-top:4px"></div><div style="flex:1;background:var(--bg);border-radius:5px;padding:6px 9px;border:1px solid var(--b1)"><div style="display:flex;justify-content:space-between;font-family:var(--mono);font-size:8px;margin-bottom:2px"><span style="color:var(--g);font-weight:700">'+h.status+'</span><span style="color:var(--tx3)">'+h.at+(h.by?' ¬∑ '+h.by:'')+'</span></div>'+(h.note?'<div style="font-size:10px;color:var(--tx2)">'+esc(h.note)+'</div>':'')+'</div></div>').join('')+'</div>':'');

  document.getElementById('detEditBtn').onclick=()=>{closeOv('ovDetail');openEdit(id);};
  document.getElementById('detDispBtn').onclick=()=>{closeOv('ovDetail');openDisp(id);};
  openOv('ovDetail');
}

// KOMENTAR
function openKmt(id){openDetail(id);setTimeout(()=>{const el=document.getElementById('cmtI-'+id);if(el){el.focus();el.scrollIntoView({behavior:'smooth'});}},250);}

function sendCmt(sid){
  const el=document.getElementById('cmtI-'+sid);if(!el)return;
  const txt=el.value.trim();if(!txt)return;
  const e={id:gid(),userId:currentUser.id,userName:currentUser.nama,userRole:currentUser.sysRole,action:'KOMENTAR',suratId:sid,suratJudul:'',extra:txt,ts:new Date().toISOString()};
  if(isDemo){D.activity[e.id]=e;onChanged();}else db.ref('activity/'+e.id).set(e);
  el.value='';
  setTimeout(()=>openDetail(sid),80);
  showToast('Komentar terkirim','success');
}

function delCmt(cid,sid){
  if(isDemo){delete D.activity[cid];onChanged();}else db.ref('activity/'+cid).remove();
  setTimeout(()=>openDetail(sid),80);
  showToast('Komentar dihapus','warn');
}

// TAMBAH SURAT
function tambahSurat(){
if(!canDo('add')){showToast('Anda tidak memiliki akses untuk menambah surat','error');return;}
  const judul=document.getElementById('iJudul').value.trim();
  const e=document.getElementById('tambahErr');
  if(!judul){e.textContent='‚ö† Judul wajib diisi';return;}
  e.textContent='';
  const id=gid();
  const s={id,judul,jenis:document.getElementById('iJenis').value,prioritas:document.getElementById('iPrio').value,status:'DRAFT',deadline:document.getElementById('iDl').value||'',kepada:document.getElementById('iKpd').value.trim(),pic:document.getElementById('iPIC').value.trim()||currentUser.nama,ref:document.getElementById('iRef').value.trim(),desc:document.getElementById('iDesc').value.trim(),createdAt:tod(),createdBy:currentUser.nama,history:[{status:'DRAFT',note:'Dibuat oleh '+currentUser.nama,at:tod(),by:currentUser.nama}]};
  dbW('surat/'+id,s);
  logAct('TAMBAH_SURAT',s.judul,'Prioritas: '+s.prioritas);
  clearForm();showToast('Surat disimpan','success');showPanel('daftar');
}

function clearForm(){
  ['iJudul','iDl','iKpd','iRef','iDesc'].forEach(i=>document.getElementById(i).value='');
  document.getElementById('iPIC').value=currentUser.nama;
  document.getElementById('iPrio').value='MEDIUM';
  document.getElementById('tambahErr').textContent='';
  cc('iJudul','ccj',200);cc('iDesc','ccd',1000);
}
function cc(id,cid,mx){const l=document.getElementById(id).value.length;const el=document.getElementById(cid);el.textContent=l+'/'+mx;el.style.color=l>mx*.85?'var(--w)':'var(--tx3)';}

// EDIT
function openEdit(id){
  const s=Object.values(D.surat||{}).find(x=>x.id===id);if(!s)return;
  document.getElementById('editId').value=id;
  document.getElementById('eJudul').value=s.judul;
  document.getElementById('eJenis').value=s.jenis;
  document.getElementById('ePrioritas').value=s.prioritas;
  // Populate status dropdown based on permissions
const statusSel=document.getElementById('eStatus');
const availStatuses=getStatusOpts(s.status);
statusSel.innerHTML=availStatuses.map(st=>'<option value="'+st+'">'+st.replace(/_/g,' ')+'</option>').join('');
statusSel.value=s.status;
// Show P-Office field only if SIAP_POFFICE
const poffWrap=document.getElementById('eNomorPOfficeWrap');
if(poffWrap){
  poffWrap.style.display=(s.status==='SIAP_POFFICE'||s.status==='DI_POFFICE')?'block':'none';
  if(s.status==='SIAP_POFFICE'&&!canDo('poffice')){
    document.getElementById('eNomorPOffice').disabled=true;
  }
}
  document.getElementById('eDl').value=s.deadline||'';
  document.getElementById('eKpd').value=s.kepada||'';
  document.getElementById('ePIC').value=s.pic||'';
  document.getElementById('eRef').value=s.ref||'';
  document.getElementById('eDesc').value=s.desc||'';
  document.getElementById('eNote').value='';
  openOv('ovEdit');
}

function saveEdit(){
  const id=document.getElementById('editId').value;
  const s=Object.values(D.surat||{}).find(x=>x.id===id);
  if(!s)return;
  if(!canDo('edit',s)){showToast('Anda tidak dapat edit surat ini','error');return;}
  
  const newStatus=document.getElementById('eStatus').value;
  const nomorPO=document.getElementById('eNomorPOffice')?document.getElementById('eNomorPOffice').value:'';
  
  // Validate P-Office number required before DI_POFFICE
  if(newStatus==='DI_POFFICE'&&!nomorPO){
    showToast('Nomor P-Office wajib diisi sebelum status DI_POFFICE','error');
    return;
  }
  
  // Validate Sekretaris can fill P-Office number
  if(nomorPO&&s.nomorPOffice!==nomorPO&&!canDo('poffice')){
    showToast('Hanya Sekretaris TS yang dapat isi Nomor P-Office','error');
    return;
  }
  const id=document.getElementById('editId').value;
  const s=Object.values(D.surat||{}).find(x=>x.id===id);if(!s)return;
  const judul=document.getElementById('eJudul').value.trim();
  if(!judul){showToast('Judul wajib diisi','error');return;}
  const nSt=document.getElementById('eStatus').value,note=document.getElementById('eNote').value.trim();
  const hist=[...(s.history||[])];
  if(nSt!==s.status||note)hist.push({status:nSt,note:note||'Diubah oleh '+currentUser.nama,at:tod(),by:currentUser.nama});
  const up={...s,judul,jenis:document.getElementById('eJenis').value,prioritas:document.getElementById('ePrioritas').value,status:nSt,deadline:document.getElementById('eDl').value||'',kepada:document.getElementById('eKpd').value.trim(),pic:document.getElementById('ePIC').value.trim(),ref:document.getElementById('eRef').value.trim(),desc:document.getElementById('eDesc').value.trim(),history:hist};
  dbW('surat/'+id,up);
  logAct('EDIT_SURAT',judul,'Status: '+nSt+(note?' ‚Äî '+note:''));
  closeOv('ovEdit');showToast('Surat diperbarui','success');
}

function qSelesai(id){
  const s=Object.values(D.surat||{}).find(x=>x.id===id);if(!s)return;
  const hist=[...(s.history||[]),{status:'SELESAI',note:'Ditandai selesai oleh '+currentUser.nama,at:tod(),by:currentUser.nama}];
  dbW('surat/'+id,{...s,status:'SELESAI',history:hist});
  logAct('SELESAI',s.judul,'');
  showToast('Surat SELESAI ‚úì','success');
}

function cfmHapusSurat(id){
const s=Object.values(D.surat||{}).find(x=>x.id===id);
if(!s)return;
if(!canDo('delete',s)){showToast('Hanya Manager yang dapat menghapus surat','error');return;}
  const s=Object.values(D.surat||{}).find(x=>x.id===id);if(!s)return;
  document.getElementById('cfmMsg').textContent='Hapus surat "'+s.judul.substring(0,60)+'"? Disposisi terkait juga dihapus.';
  pendingDel=()=>{
    dbR('surat/'+id);
    Object.values(D.disposisi||{}).filter(d=>d.suratId===id).forEach(d=>dbR('disposisi/'+d.id));
    logAct('HAPUS_SURAT',s.judul,'');
    closeOv('cfmOv');showToast('Surat dihapus','warn');
  };
  document.getElementById('cfmOkBtn').onclick=pendingDel;
  openOv('cfmOv');
}

// DISPOSISI
function openDisp(sid,did){
  const s=Object.values(D.surat||{}).find(x=>x.id===sid);if(!s)return;
  document.getElementById('dSuratId').value=sid;
  document.getElementById('dDispId').value=did||'';
  document.getElementById('dispInfo').innerHTML='<strong>'+esc(s.judul)+'</strong><br><span style="font-size:10px">'+esc(s.jenis)+' ¬∑ '+esc(s.ref||'-')+'</span>';
  const sel=document.getElementById('dAng');
  sel.innerHTML='<option value="">-- Pilih Anggota --</option>'+Object.values(D.anggota||{}).map(a=>'<option value="'+a.id+'">'+esc(a.nama)+' ‚Äî '+esc(a.jabatan)+'</option>').join('');
  if(did){const d=Object.values(D.disposisi||{}).find(x=>x.id===did);if(d){sel.value=d.anggotaId;document.getElementById('dDl').value=d.deadline||'';document.getElementById('dNote').value=d.note||'';}}
  else{document.getElementById('dDl').value=s.deadline||'';document.getElementById('dNote').value='';}
  openOv('ovDisp');
}

function saveDisp(){
  const sid=document.getElementById('dSuratId').value,did=document.getElementById('dDispId').value;
  const aid=document.getElementById('dAng').value;
  if(!aid){showToast('Pilih anggota','error');return;}
  const a=Object.values(D.anggota||{}).find(x=>x.id===aid);
  const note=document.getElementById('dNote').value.trim(),dl=document.getElementById('dDl').value;
  const s=Object.values(D.surat||{}).find(x=>x.id===sid);
  if(did){const d=Object.values(D.disposisi||{}).find(x=>x.id===did);if(d)dbW('disposisi/'+did,{...d,anggotaId:aid,note,deadline:dl});}
  else{
    const id=gid();
    dbW('disposisi/'+id,{id,suratId:sid,anggotaId:aid,note,deadline:dl,createdAt:tod(),createdBy:currentUser.nama,done:false});
    if(s&&s.status==='DRAFT'){const hist=[...(s.history||[]),{status:'PROSES',note:'Disposisi ke '+(a?a.nama:'?'),at:tod(),by:currentUser.nama}];dbW('surat/'+sid,{...s,status:'PROSES',history:hist});}
  }
  logAct('DISPOSISI',s?s.judul:'','Ke: '+(a?a.nama:'?')+(note?' ‚Äî '+note:''));
  closeOv('ovDisp');showToast('Disposisi '+(did?'diperbarui':'dikirim')+' ke '+(a?a.nama:'anggota'),'success');
}

function toggleTask(did){
  const d=Object.values(D.disposisi||{}).find(x=>x.id===did);if(!d)return;
  dbW('disposisi/'+did,{...d,done:!d.done});
  const s=Object.values(D.surat||{}).find(x=>x.id===d.suratId);
  logAct(d.done?'BUKA_TUGAS':'SELESAI_TUGAS',s?s.judul:'','');
  showToast(!d.done?'Tugas selesai ‚úì':'Tugas dibuka kembali','success');
}

function hapusDisp(did){
  document.getElementById('cfmMsg').textContent='Hapus disposisi ini?';
  pendingDel=()=>{dbR('disposisi/'+did);closeOv('cfmOv');showToast('Disposisi dihapus','warn');};
  document.getElementById('cfmOkBtn').onclick=pendingDel;
  openOv('cfmOv');
}

// REMINDER
function renderReminder(){
  const cont=document.getElementById('reminderList');
  const active=Object.values(D.surat||{}).filter(s=>s.status!=='SELESAI'&&s.deadline);
  document.getElementById('remCnt').textContent=active.length+' surat aktif';
  active.sort((a,b)=>new Date(a.deadline)-new Date(b.deadline));
  if(!active.length){cont.innerHTML='<div class="empty"><span class="empty-icon">üéâ</span>Tidak ada deadline aktif!</div>';return;}
  const ov=[],td=[],sn=[],ok=[];
  active.forEach(s=>{const d=dLeft(s.deadline);if(d<0)ov.push({...s,d});else if(d===0)td.push({...s,d});else if(d<=3)sn.push({...s,d});else ok.push({...s,d});});
  const grp=(items,lbl,col)=>!items.length?'':
    '<div style="font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:1px;color:'+col+';margin:11px 0 6px;padding-bottom:5px;border-bottom:1px solid var(--b1)">'+lbl+' ('+items.length+')</div>'+
    items.map(s=>{
      const d=s.d;let ic='ok',dc='ok',dt=d+'h lagi';
      if(d<0){ic='ov';dc='ov';dt=Math.abs(d)+'h TERLAMBAT';}else if(d===0){ic='td';dc='td';dt='HARI INI!';}else if(d<=3){ic='sn';dc='sn';}
      const cs=getCS(s);
      return '<div class="rem-card"><div class="rind '+ic+'"></div><div class="rbody"><div class="rtitle">'+esc(s.judul)+'</div><div class="rmeta">'+esc(s.jenis)+' ¬∑ '+esc(s.kepada||'-')+' ¬∑ PIC: '+esc(s.pic||'-')+'</div></div><div><div class="rdays '+dc+'">'+dt+'</div><div class="rdate">'+fmtD(s.deadline)+'</div><div style="display:flex;gap:3px;margin-top:4px;justify-content:flex-end"><button class="btn bsm bwrn" style="padding:2px 7px;font-size:8px" onclick="openEdit(\''+s.id+'\')">Edit</button><button class="btn bsm bsuc" style="padding:2px 7px;font-size:8px" onclick="qSelesai(\''+s.id+'\');renderReminder()">‚úì</button></div></div></div>';
    }).join('');
  cont.innerHTML=grp(ov,'üî¥ TERLAMBAT','var(--r)')+grp(td,'üü° HARI INI','var(--w)')+grp(sn,'üîµ 3 HARI KE DEPAN','var(--a)')+grp(ok,'üü¢ JADWAL OK','var(--g)');
}

// DISPOSISI PANEL
function renderDispPanel(){
  const cont=document.getElementById('dispTracker');
  const angs=Object.values(D.anggota||{});
  if(!angs.length){cont.innerHTML='<div class="empty"><span class="empty-icon">üë•</span>Belum ada anggota tim</div>';return;}
  cont.innerHTML='<div class="angGrid">'+angs.map(a=>{
    const tasks=Object.values(D.disposisi||{}).filter(d=>d.anggotaId===a.id);
    const done=tasks.filter(t=>t.done).length,pct=tasks.length?Math.round(done/tasks.length*100):0;
    const col=avC(a.nama);
    return '<div class="angCard">'+
      '<div class="angTop"><div class="angAv" style="background:'+col+'22;border-color:'+col+';color:'+col+'">'+inits(a.nama)+'</div>'+
      '<div style="flex:1"><div class="angName">'+esc(a.nama)+'</div><div class="angRole">'+esc(a.jabatan)+(a.kontak?' ¬∑ '+esc(a.kontak):'')+'</div></div>'+
      '<div><div class="angStats"><span class="bdg bP">'+(tasks.length-done)+' aktif</span><span class="bdg bS">'+done+' selesai</span></div>'+(tasks.length?'<div style="font-family:var(--mono);font-size:9px;color:var(--tx3);text-align:right;margin-top:2px">'+pct+'%</div>':'')+
      '</div></div>'+
      (tasks.length?'<div class="prog"><div class="prog-f '+(pct===100?'full':'')+'" style="width:'+pct+'%"></div></div>':'')+
      '<div class="task-list">'+(!tasks.length?'<div style="color:var(--tx3);font-size:10px;font-family:var(--mono);padding:4px 0">Tidak ada tugas aktif</div>':
        tasks.map(t=>{
          const s=Object.values(D.surat||{}).find(x=>x.id===t.suratId);
          const dR=t.deadline?dLeft(t.deadline):null;
          const dc=dR===null?'var(--tx3)':dR<0?'var(--r)':dR<=2?'var(--w)':'var(--tx3)';
          return '<div class="task-i '+(t.done?'dn':'')+'"><div class="tcb '+(t.done?'chk':'')+'" onclick="toggleTask(\''+t.id+'\')" title="Toggle selesai">'+(t.done?'‚úì':'')+'</div>'+
            '<div class="tlbl" title="'+(s?esc(s.judul):'(dihapus)')+'">'+
              '<div style="font-weight:600">'+(s?esc(s.judul.length>42?s.judul.substring(0,42)+'...':s.judul):'(dihapus)')+'</div>'+
              (t.note?'<div style="color:var(--tx2);font-size:9px">'+esc(t.note)+'</div>':'')+
            '</div>'+
            (t.deadline?'<div class="tdl" style="color:'+dc+'">'+fmtD(t.deadline)+'</div>':'')+
            '<div style="display:flex;gap:2px;flex-shrink:0">'+
              (s?'<button class="btn bsm bgst" style="padding:2px 5px;font-size:8px" onclick="openDisp(\''+t.suratId+'\',\''+t.id+'\')">‚úè</button>':'')+
              '<button class="btn bsm bdng" style="padding:2px 5px;font-size:8px" onclick="hapusDisp(\''+t.id+'\')">‚úï</button>'+
            '</div></div>';
        }).join(''))+
      '</div></div>';
  }).join('')+'</div>';
}

// ACTIVITY
function renderActivity(){
  const cont=document.getElementById('activityFeed');
  const acts=Object.values(D.activity||{}).filter(a=>a.action!=='LOGIN').sort((a,b)=>b.ts>a.ts?1:-1).slice(0,100);
  document.getElementById('actCnt').textContent=acts.length+' entri';
  if(!acts.length){cont.innerHTML='<div class="empty"><span class="empty-icon">üì≠</span>Belum ada aktivitas</div>';return;}
  const ics={TAMBAH_SURAT:'‚úö',EDIT_SURAT:'‚úè',HAPUS_SURAT:'‚úï',DISPOSISI:'‚Üí',SELESAI:'‚úì',SELESAI_TUGAS:'‚úì',BUKA_TUGAS:'‚Ü∫',KOMENTAR:'üí¨',TAMBAH_ANGGOTA:'üë§'};
  const cls={TAMBAH_SURAT:'var(--g)',EDIT_SURAT:'var(--w)',HAPUS_SURAT:'var(--r)',DISPOSISI:'var(--a)',SELESAI:'var(--g)',SELESAI_TUGAS:'var(--g)',BUKA_TUGAS:'var(--tx2)',KOMENTAR:'var(--p)',TAMBAH_ANGGOTA:'var(--a)'};
  cont.innerHTML=acts.map(a=>{
    const col=cls[a.action]||'var(--tx2)',ic=ics[a.action]||'‚Ä¢',uc=avC(a.userName||'?');
    return '<div class="act-item"><div class="act-av" style="background:'+uc+'22;border-color:'+uc+';color:'+uc+'">'+inits(a.userName||'?')+'</div><div class="act-body"><div class="act-who">'+esc(a.userName)+' <span style="font-family:var(--mono);font-size:9px;color:var(--tx3)">'+esc(a.userRole||'')+'</span></div><div class="act-what"><span class="act-tag" style="color:'+col+';border-color:'+col+'1a;background:'+col+'10">'+ic+' '+a.action.replace(/_/g,' ')+'</span>'+(a.suratJudul?'"<strong>'+esc(a.suratJudul.substring(0,50))+'</strong>" ':''+(a.extra?'‚Äî '+esc(a.extra):''))+'</div><div class="act-when">'+fmtDT(a.ts)+'</div></div></div>';
  }).join('');
}

// NOTIF
function renderNotif(){
  const cont=document.getElementById('notifContent');
  const ov=Object.values(D.surat||{}).filter(s=>getCS(s)==='OVERDUE');
  const td=Object.values(D.surat||{}).filter(s=>s.status!=='SELESAI'&&s.deadline&&dLeft(s.deadline)===0);
  const me=Object.values(D.anggota||{}).find(x=>x.nama===currentUser.nama);
  const myD=me?Object.values(D.disposisi||{}).filter(d=>d.anggotaId===me.id&&!d.done):[];
  if(!ov.length&&!td.length&&!myD.length){cont.innerHTML='<div style="color:var(--tx3);font-family:var(--mono);font-size:11px;padding:20px;text-align:center">‚úÖ Tidak ada notifikasi aktif</div>';return;}
  let h='';
  ov.forEach(s=>{h+='<div class="ni"><div class="ni-icon">üî¥</div><div class="ni-body"><div class="ni-msg"><strong>'+esc(s.judul)+'</strong> ‚Äî <span style="color:var(--r)">OVERDUE '+Math.abs(dLeft(s.deadline))+' hari</span></div><div class="ni-time">Deadline: '+fmtD(s.deadline)+'</div></div></div>';});
  td.forEach(s=>{h+='<div class="ni"><div class="ni-icon">üü°</div><div class="ni-body"><div class="ni-msg"><strong>'+esc(s.judul)+'</strong> ‚Äî <span style="color:var(--w)">HARI INI!</span></div><div class="ni-time">'+esc(s.jenis)+' ¬∑ PIC: '+esc(s.pic||'-')+'</div></div></div>';});
  myD.forEach(d=>{const s=Object.values(D.surat||{}).find(x=>x.id===d.suratId);h+='<div class="ni"><div class="ni-icon">üìã</div><div class="ni-body"><div class="ni-msg">Tugas: <strong>'+(s?esc(s.judul.substring(0,50)):'?')+'</strong></div><div class="ni-time">'+(d.note?esc(d.note)+' ¬∑ ':'')+' Deadline: '+fmtD(d.deadline)+'</div></div></div>';});
  cont.innerHTML=h;
}

// ANGGOTA
function tambahAnggota(){
if(!canDo('anggota')){showToast('Hanya Manager yang dapat kelola anggota','error');return;}
  const nama=document.getElementById('iNama').value.trim();
  const e=document.getElementById('angErr');
  if(!nama){e.textContent='‚ö† Nama wajib diisi';return;}
  if(Object.values(D.anggota||{}).find(a=>a.nama.toLowerCase()===nama.toLowerCase())){e.textContent='‚ö† Nama sudah ada';return;}
  e.textContent='';
  const id=gid();
  dbW('anggota/'+id,{id,nama,jabatan:document.getElementById('iJabatan').value.trim(),kontak:document.getElementById('iKontak').value.trim()});
  logAct('TAMBAH_ANGGOTA',nama,'');
  ['iNama','iJabatan','iKontak'].forEach(i=>document.getElementById(i).value='');
  showToast('"'+nama+'" ditambahkan','success');
}

function editAnggota(id){
  const a=Object.values(D.anggota||{}).find(x=>x.id===id);if(!a)return;
  const n=prompt('Nama:',a.nama);if(!n||!n.trim())return;
  const j=prompt('Jabatan:',a.jabatan||'');
  const k=prompt('Kontak:',a.kontak||'');
  dbW('anggota/'+id,{...a,nama:n.trim(),jabatan:(j||'').trim(),kontak:(k||'').trim()});
  showToast('Anggota diperbarui','success');
}

function cfmHapusAnggota(id){
  const a=Object.values(D.anggota||{}).find(x=>x.id===id);if(!a)return;
  const cnt=Object.values(D.disposisi||{}).filter(d=>d.anggotaId===id).length;
  document.getElementById('cfmMsg').textContent='Hapus "'+a.nama+'"?'+(cnt?' '+cnt+' disposisi ikut dihapus.':'');
  pendingDel=()=>{
    dbR('anggota/'+id);
    Object.values(D.disposisi||{}).filter(d=>d.anggotaId===id).forEach(d=>dbR('disposisi/'+d.id));
    closeOv('cfmOv');showToast('Anggota dihapus','warn');
  };
  document.getElementById('cfmOkBtn').onclick=pendingDel;
  openOv('cfmOv');
}

function renderAngGrid(){
  const g=document.getElementById('angGrid');
  const angs=Object.values(D.anggota||{});
  if(!angs.length){g.innerHTML='<div class="empty" style="grid-column:1/-1"><span class="empty-icon">üë§</span>Belum ada anggota</div>';return;}
  g.innerHTML=angs.map(a=>{
    const tot=Object.values(D.disposisi||{}).filter(d=>d.anggotaId===a.id).length;
    const dn=Object.values(D.disposisi||{}).filter(d=>d.anggotaId===a.id&&d.done).length;
    const col=avC(a.nama);
    return '<div class="angCard"><div class="angTop"><div class="angAv" style="background:'+col+'22;border-color:'+col+';color:'+col+'">'+inits(a.nama)+'</div><div style="flex:1"><div class="angName">'+esc(a.nama)+'</div><div class="angRole">'+esc(a.jabatan||'-')+(a.kontak?' ¬∑ '+esc(a.kontak):'')+'</div></div><div style="display:flex;gap:4px"><button class="btn bsm bgst" onclick="editAnggota(\''+a.id+'\')">‚úè</button><button class="btn bsm bdng" onclick="cfmHapusAnggota(\''+a.id+'\')">‚úï</button></div></div><div class="angStats"><span class="bdg bP">'+(tot-dn)+' aktif</span><span class="bdg bS">'+dn+' selesai</span><span class="bdg bD">'+tot+' total</span></div></div>';
  }).join('');
}

// OVERLAY
function openOv(id){document.getElementById(id).classList.add('open');}
function closeOv(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.ov').forEach(o=>{o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');});});
document.addEventListener('keydown',e=>{if(e.key==='Escape')document.querySelectorAll('.ov.open').forEach(o=>o.classList.remove('open'));});

// TOAST
function showToast(msg,type='success'){
  const wrap=document.getElementById('tw'),t=document.createElement('div');
  t.className='toast t'+type[0];
  t.innerHTML='<span>'+{success:'‚úì',error:'‚úï',warn:'‚ö†',info:'‚Ñπ'}[type]+'</span><span style="flex:1">'+esc(msg)+'</span><span class="tclose" onclick="this.parentElement.remove()">‚úï</span>';
  wrap.appendChild(t);
  setTimeout(()=>{t.style.transition='.3s';t.style.opacity='0';t.style.transform='translateX(110%)';setTimeout(()=>{if(t.parentElement)t.remove();},300);},4000);
}

// INIT
(function(){
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyDGoTKyse6Eu-HCiP8Iyo5wRNOlWIflF3k",
    authDomain: "kpb-surat-tim.firebaseapp.com",
    databaseURL: "https://kpb-surat-tim-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "kpb-surat-tim",
    storageBucket: "kpb-surat-tim.firebasestorage.app",
    messagingSenderId: "1089579741546",
    appId: "1:1089579741546:web:da21a0a9fdf672e1147513"
  };
  const savedUser=localStorage.getItem(USER_KEY);
  localStorage.setItem(CFG_KEY,JSON.stringify(FIREBASE_CONFIG));
  document.getElementById('loadingScreen').classList.add('hidden');
  try{
    if(firebase.apps.length>0){
      firebase.apps[0].delete().then(()=>{
        firebase.initializeApp(FIREBASE_CONFIG);
        db=firebase.database();
        if(savedUser){currentUser=JSON.parse(savedUser);startApp();}else{showLogin();}
      });
    }else{
      firebase.initializeApp(FIREBASE_CONFIG);
      db=firebase.database();
      if(savedUser){currentUser=JSON.parse(savedUser);startApp();}else{showLogin();}
    }
  }catch(err){console.error('Firebase:',err);alert('Koneksi Firebase gagal');showLogin();}
})();
</script>

<script>
'use strict';
const CFG_KEY='kpb_fb_cfg_v2',USER_KEY='kpb_user_v2',DEMO_KEY='kpb_demo_v2',SEED_KEY='kpb_seeded_v2';
let db=null,isDemo=false,currentUser=null,activeFilter='ALL',pendingDel=null,selR='Manager';
let D={surat:{},anggota:{},disposisi:{},activity:{}};

const gid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,6);
const tod=()=>new Date().toISOString().slice(0,10);
const fmtD=d=>{if(!d)return'-';try{return new Date(d).toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'});}catch(e){return d;}};
const fmtDT=ts=>{if(!ts)return'';try{const x=new Date(ts);return x.toLocaleDateString('id-ID',{day:'2-digit',month:'short'})+' '+x.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'});}catch(e){return'';}};
const dLeft=dl=>{const t=new Date();t.setHours(0,0,0,0);const d=new Date(dl);d.setHours(0,0,0,0);return Math.round((d-t)/86400000);};
const esc=s=>{if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');};
const getCS=s=>{if(s.status==='SELESAI')return'SELESAI';if(s.deadline&&dLeft(s.deadline)<0)return'OVERDUE';return s.status;};
const AVC=['var(--g)','var(--a)','var(--w)','var(--r)','var(--p)'];
const avC=n=>{let h=0;for(let i=0;i<n.length;i++)h+=n.charCodeAt(i);return AVC[h%AVC.length];};
const inits=n=>(n||'?').split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();

// AUTO-SEED FIREBASE dengan data asli Pak Salim
function autoSeedFirebase(){
  if(isDemo||!db)return;
  const seeded=localStorage.getItem(SEED_KEY);
  if(seeded)return; // Sudah pernah seed

  const d=n=>{const x=new Date();x.setDate(x.getDate()+n);return x.toISOString().slice(0,10);};
  
  // Data 6 surat asli dari catatan 10/02/26
  const suratData=[
    {judul:'Kegagalan Globe Valve Line LG',jenis:'Surat Kerja',prioritas:'HIGH',deadline:d(2),kepada:'Manager Operasi',pic:'Salim',ref:'Globe Valve - Line LG',desc:'Laporan kegagalan globe valve pada line LG. Perlu analisa root cause dan rekomendasi perbaikan segera.'},
    {judul:'Complaint Leak Boiler A',jenis:'Surat Complaint',prioritas:'HIGH',deadline:d(1),kepada:'Kontraktor / Vendor Boiler',pic:'Salim',ref:'Boiler A',desc:'Surat komplain terkait temuan leak pada Boiler A. Meminta perbaikan segera sesuai kontrak.'},
    {judul:'BFW-D ‚Äî Instrument dan Rotating',jenis:'Surat BFW',prioritas:'MEDIUM',deadline:d(5),kepada:'Dept. Instrument & Rotating',pic:'Salim',ref:'BFW-D',desc:'Koordinasi BFW-D untuk Instrument dan Rotating. Konfirmasi kesiapan komisioning.',status:'PROSES'},
    {judul:'Balik SWPO Complaint',jenis:'Surat Complaint',prioritas:'MEDIUM',deadline:d(4),kepada:'SWPO / Vendor',pic:'Salim',ref:'SWPO',desc:'Surat balasan atas complaint dari SWPO.'},
    {judul:'Peminjaman OV-0162A ‚Äî Valve dibebaskan',jenis:'Surat Peminjaman',prioritas:'HIGH',deadline:d(0),kepada:'Dept. Asset Owner',pic:'Salim',ref:'OV-0162A',desc:'Surat peminjaman valve OV-0162A untuk kebutuhan komisioning RFCC.'},
    {judul:'Peminjaman ‚Äî Modifikasi Line Hopper',jenis:'Surat Peminjaman',prioritas:'MEDIUM',deadline:d(6),kepada:'Dept. Terkait',pic:'Salim',ref:'Line Hopper',desc:'Surat peminjaman terkait modifikasi line hopper untuk komisioning.'}
  ];

  // Anggota tim default
  const anggotaData=[
    {nama:'Ahmad Rizky',jabatan:'Instrument Engineer',kontak:'ext 1201'},
    {nama:'Budi Santoso',jabatan:'Rotating Equipment Tech',kontak:'ext 1202'},
    {nama:'Candra Wijaya',jabatan:'Process Engineer',kontak:'ext 1203'},
    {nama:'Dewi Rahmawati',jabatan:'Document Control',kontak:'ext 1204'}
  ];

  // Seed ke Firebase
  suratData.forEach(s=>{
    const id=gid();
    const hist=[{status:s.status||'DRAFT',note:'Surat dibuat',at:tod(),by:'Salim'}];
    if(s.status==='PROSES')hist.push({status:'PROSES',note:'Sudah diserahkan ke dept',at:tod(),by:'Salim'});
    db.ref('surat/'+id).set({id,...s,status:s.status||'DRAFT',createdAt:tod(),createdBy:'Salim',history:hist});
  });

  anggotaData.forEach(a=>{
    const id=gid();
    db.ref('anggota/'+id).set({id,...a});
  });

  localStorage.setItem(SEED_KEY,'1');
  showToast('Data 6 surat & 4 anggota tim berhasil dimuat','success');
}
// SETUP
function goStep(n){document.querySelectorAll('.setup-step').forEach(s=>s.classList.remove('active'));document.getElementById('step'+n).classList.add('active');}

function validateFb(){
  const raw=document.getElementById('fbConfigInput').value.trim();
  const e=document.getElementById('fbErr');
  if(!raw){e.textContent='‚ö† Paste konfigurasi Firebase Anda';return;}
  try{
    let js=raw;
    if(!raw.startsWith('{'))js=(raw.match(/\{[\s\S]+\}/)||[raw])[0];
    js=js.replace(/([{,]\s*)([a-zA-Z_$][a-zA-Z0-9_$]*)\s*:/g,'$1"$2":');
    const cfg=JSON.parse(js);
    if(!cfg.apiKey||!cfg.projectId){e.textContent='‚ö† Tidak lengkap ‚Äî butuh apiKey & projectId';return;}
    if(!cfg.databaseURL)cfg.databaseURL='https://'+cfg.projectId+'-default-rtdb.firebaseio.com';
    localStorage.setItem(CFG_KEY,JSON.stringify(cfg));
    e.textContent='';
    tryConnect(cfg,true);
  }catch(err){e.textContent='‚ö† Format error: '+err.message;}
}

function tryConnect(cfg,fromSetup){
  if(fromSetup)goStep(3);
  try{
    if(firebase.apps.length)firebase.apps[0].delete();
    firebase.initializeApp(cfg);
    db=firebase.database();
    if(fromSetup){
      const el=document.getElementById('testStatus');
      db.ref('.info/connected').once('value',s=>{
        if(el)el.textContent=s.val()?'‚úÖ Koneksi berhasil! Siap digunakan.':'‚ö† Tidak terhubung ‚Äî periksa databaseURL dan rules.';
      });
    }
    return true;
  }catch(err){if(fromSetup&&document.getElementById('fbErr'))document.getElementById('fbErr').textContent='‚ùå '+err.message;return false;}
}

function finishSetup(){document.getElementById('setupScreen').classList.remove('show');showLogin();}

function useDemo(){
  isDemo=true;localStorage.setItem(DEMO_KEY,'1');
  document.getElementById('setupScreen').classList.remove('show');
  seedDemo();showLogin();
}

function seedDemo(){
  const d=n=>{const x=new Date();x.setDate(x.getDate()+n);return x.toISOString().slice(0,10);};
  const a1=gid(),a2=gid(),a3=gid(),a4=gid();
  D.anggota[a1]={id:a1,nama:'Ahmad Rizky',jabatan:'Instrument Engineer',kontak:'ext 1201'};
  D.anggota[a2]={id:a2,nama:'Budi Santoso',jabatan:'Rotating Equip Tech',kontak:'ext 1202'};
  D.anggota[a3]={id:a3,nama:'Candra Wijaya',jabatan:'Process Engineer',kontak:'ext 1203'};
  D.anggota[a4]={id:a4,nama:'Dewi Rahmawati',jabatan:'Document Control',kontak:'ext 1204'};
  const ids=[gid(),gid(),gid(),gid(),gid(),gid()];
  const srt=(i,j,p,s,dl,kpd,ref,desc)=>({id:i,judul:j,jenis:p,prioritas:s,status:'DRAFT',deadline:dl,kepada:kpd,pic:'Salim',ref:ref,desc:desc,createdAt:tod(),createdBy:'Salim',history:[{status:'DRAFT',note:'Dibuat',at:tod(),by:'Salim'}]});
  D.surat[ids[0]]=srt(ids[0],'Kegagalan Globe Valve Line LG','Surat Kerja','HIGH',d(2),'Manager Operasi','Globe Valve - LG','Laporan kegagalan globe valve. Perlu analisa root cause segera.');
  D.surat[ids[1]]=srt(ids[1],'Complaint Leak Boiler A','Surat Complaint','HIGH',d(1),'Kontraktor Boiler','Boiler A','Komplain leak Boiler A. Minta perbaikan segera sesuai kontrak.');
  D.surat[ids[2]]={...srt(ids[2],'BFW-D ‚Äî Instrument dan Rotating','Surat BFW','MEDIUM',d(5),'Dept Instrument & Rotating','BFW-D','Koordinasi kesiapan BFW-D untuk komisioning.'),status:'PROSES',history:[{status:'DRAFT',note:'Dibuat',at:tod(),by:'Salim'},{status:'PROSES',note:'Diserahkan ke dept',at:tod(),by:'Salim'}]};
  D.surat[ids[3]]=srt(ids[3],'Balik SWPO Complaint','Surat Complaint','MEDIUM',d(4),'SWPO / Vendor','SWPO','Surat balasan atas complaint SWPO.');
  D.surat[ids[4]]=srt(ids[4],'Peminjaman OV-0162A ‚Äî Valve dibebaskan','Surat Peminjaman','HIGH',d(0),'Dept Asset Owner','OV-0162A','Peminjaman valve OV-0162A untuk komisioning RFCC.');
  D.surat[ids[5]]=srt(ids[5],'Peminjaman ‚Äî Modifikasi Line Hopper','Surat Peminjaman','MEDIUM',d(6),'Dept Terkait','Line Hopper','Peminjaman terkait modifikasi line hopper.');
  const did=gid();
  D.disposisi[did]={id:did,suratId:ids[2],anggotaId:a1,note:'Koordinasi readiness instrument BFW-D',deadline:d(4),createdAt:tod(),createdBy:'Salim',done:false};
}

// LOGIN
function showLogin(){
  document.getElementById('loadingScreen').classList.add('hidden');
  const ls=document.getElementById('loginScreen');
  ls.classList.add('show');ls.style.display='';
  const sv=JSON.parse(localStorage.getItem(USER_KEY)||'null');
  if(sv){document.getElementById('lNama').value=sv.nama||'';document.getElementById('lJabatan').value=sv.jabatan||'';selR=sv.sysRole||'Manager';document.querySelectorAll('.role-btn').forEach(b=>b.classList.toggle('sel',b.dataset.r===selR));}
}

function selRole(btn){selR=btn.dataset.r;document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('sel'));btn.classList.add('sel');}

function doLogin(){
  const nama=document.getElementById('lNama').value.trim();
  if(!nama){document.getElementById('lErr').textContent='‚ö† Nama wajib diisi';return;}
  currentUser={id:gid(),nama,jabatan:document.getElementById('lJabatan').value.trim(),sysRole:selR,loginAt:new Date().toISOString()};
  localStorage.setItem(USER_KEY,JSON.stringify(currentUser));
  document.getElementById('loginScreen').classList.remove('show');
  document.getElementById('loginScreen').style.display='none';
  startApp();
}

function doLogout(){
  if(!confirm('Keluar?'))return;
  if(!isDemo&&db)db.ref('online/'+currentUser.id).remove();
  document.getElementById('mainApp').style.display='none';
  const ls=document.getElementById('loginScreen');ls.classList.add('show');ls.style.display='';
}

// START APP

// START APP
function startApp(){
  // Hide tabs based on role
  if(!canDo('add')){
    const tabTambah=document.getElementById('tab-tambah');
    if(tabTambah)tabTambah.style.display='none';
  }
  if(!canDo('anggota')){
    const tabAnggota=document.getElementById('tab-anggota');
    if(tabAnggota)tabAnggota.style.display='none';
  }
  const ma=document.getElementById('mainApp');ma.style.display='block';
  const col=avC(currentUser.nama);
  const av=document.getElementById('hAv');
  av.textContent=inits(currentUser.nama);av.style.color=col;av.style.borderColor=col;av.style.background=col+'22';
  document.getElementById('hNm').textContent=currentUser.nama;
  document.getElementById('hRl').textContent=currentUser.sysRole;
  document.getElementById('iPIC').value=currentUser.nama;

  if(isDemo){setSyncSt(true,'Demo Mode');onChanged();showToast('Mode Demo ‚Äî data tidak disimpan ke cloud','info');return;}

  db.ref('.info/connected').on('value',s=>setSyncSt(s.val()===true));
  ['surat','anggota','disposisi','activity'].forEach(k=>{
    db.ref(k).on('value',snap=>{D[k]=snap.val()||{};onChanged();});
  });
  db.ref('online/'+currentUser.id).set({nama:currentUser.nama,jabatan:currentUser.jabatan,ts:new Date().toISOString()});
  db.ref('online/'+currentUser.id).onDisconnect().remove();
  db.ref('online').on('value',snap=>{
    const u=snap.val()||{};
    const bar=document.getElementById('onlineBar');
    const list=Object.values(u);
    bar.innerHTML='<span>üü¢ Online:</span>'+list.map(x=>'<div class="ou-chip"><div class="ou-dot"></div>'+esc(x.nama)+'</div>').join('');
  });
  
  // AUTO-SEED DATA ASLI PAK SALIM
  autoSeedFirebase();
  
  logAct('LOGIN','','');
}
function setSyncSt(ok,lbl){const d=document.getElementById('sdot'),t=document.getElementById('stxt');d.classList.toggle('off',!ok);t.textContent=lbl||(ok?'Terhubung':'Offline');}

function onChanged(){
  updateStats();
  if(document.getElementById('panel-daftar').classList.contains('active'))renderList();
  if(document.getElementById('panel-reminder').classList.contains('active'))renderReminder();
  if(document.getElementById('panel-disp').classList.contains('active'))renderDispPanel();
  if(document.getElementById('panel-activity').classList.contains('active'))renderActivity();
  if(document.getElementById('panel-anggota').classList.contains('active'))renderAngGrid();
}

// DB OPS
function dbW(path,data){
  if(isDemo){const p=path.split('/').filter(Boolean);let o=D;for(let i=0;i<p.length-1;i++){if(!o[p[i]])o[p[i]]={};o=o[p[i]];}o[p[p.length-1]]=data;onChanged();return;}
  db.ref(path).set(data);
}
function dbR(path){
  if(isDemo){const p=path.split('/').filter(Boolean);let o=D;for(let i=0;i<p.length-1;i++)o=(o[p[i]]||{});delete o[p[p.length-1]];onChanged();return;}
  db.ref(path).remove();
}
function logAct(action,suratJudul,extra){
  if(!currentUser)return;
  const e={id:gid(),userId:currentUser.id,userName:currentUser.nama,userRole:currentUser.sysRole,action,suratJudul:suratJudul||'',extra:extra||'',ts:new Date().toISOString()};
  if(isDemo){D.activity[e.id]=e;onChanged();return;}
  db.ref('activity/'+e.id).set(e);
}

// STATS
function updateStats(){
  const all=Object.values(D.surat||{});
  const cs=all.map(s=>getCS(s));
  document.getElementById('sv0').textContent=all.length;
  document.getElementById('sv1').textContent=cs.filter(s=>s==='DRAFT').length;
  document.getElementById('sv2').textContent=cs.filter(s=>s==='PROSES').length;
  document.getElementById('sv3').textContent=cs.filter(s=>s==='OVERDUE').length;
  document.getElementById('sv4').textContent=cs.filter(s=>s==='SELESAI').length;
  const urg=cs.filter(s=>s==='OVERDUE').length+all.filter(s=>s.status!=='SELESAI'&&s.deadline&&dLeft(s.deadline)===0).length;
  document.getElementById('nDot').classList.toggle('hidden',urg===0);
}

// PANELS
function showPanel(n){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('panel-'+n).classList.add('active');
  document.getElementById('tab-'+n).classList.add('active');
  if(n==='daftar')renderList();
  if(n==='reminder')renderReminder();
  if(n==='disp')renderDispPanel();
  if(n==='activity')renderActivity();
  if(n==='anggota')renderAngGrid();
}

// FILTER & LIST
function setFilter(f,btn){
  activeFilter=f;
  document.querySelectorAll('#filterChips .chip').forEach(c=>{c.classList.remove('on','oD','oP','oO','oS');});
  const cls={ALL:'on',DRAFT:'oD',PROSES:'oP',OVERDUE:'oO',SELESAI:'oS'};
  if(btn)btn.classList.add(cls[f]||'on');
  else{const c=document.querySelector('#filterChips [data-f="'+f+'"]');if(c)c.classList.add(cls[f]||'on');}
  showPanel('daftar');
}

function renderList(){
  const cont=document.getElementById('suratList');
  const q=(document.getElementById('srch').value||'').toLowerCase().trim();
  const sort=document.getElementById('sortSel').value;
  let items=Object.values(D.surat||{}).map(s=>({...s,_cs:getCS(s)}));
  if(activeFilter!=='ALL')items=items.filter(s=>s._cs===activeFilter);
  if(q)items=items.filter(s=>(s.judul||'').toLowerCase().includes(q)||(s.ref||'').toLowerCase().includes(q)||(s.kepada||'').toLowerCase().includes(q)||(s.desc||'').toLowerCase().includes(q)||(s.pic||'').toLowerCase().includes(q));
  const po={HIGH:0,MEDIUM:1,LOW:2},so={OVERDUE:0,DRAFT:1,PROSES:2,SELESAI:3};
  if(sort==='dl-asc')items.sort((a,b)=>(a.deadline||'9')>(b.deadline||'9')?1:-1);
  else if(sort==='dl-desc')items.sort((a,b)=>(a.deadline||'0')<(b.deadline||'0')?1:-1);
  else if(sort==='pri')items.sort((a,b)=>po[a.prioritas]-po[b.prioritas]);
  else if(sort==='new')items.sort((a,b)=>b.createdAt>a.createdAt?1:-1);
  else if(sort==='st')items.sort((a,b)=>so[a._cs]-so[b._cs]);

  if(!items.length){cont.innerHTML='<div class="empty"><span class="empty-icon">üì≠</span>'+(q?'Tidak ada hasil: "'+esc(q)+'"':'Tidak ada surat')+' </div>';updateStats();return;}

  cont.innerHTML=items.map(s=>{
    const cs=s._cs,dl=s.deadline?dLeft(s.deadline):null;
    let dlTxt='',dlCls='';
    if(dl!==null){if(dl<0){dlTxt='‚ö† '+Math.abs(dl)+'h terlambat';dlCls='ur';}else if(dl===0){dlTxt='‚ö° Hari ini!';dlCls='wn';}else if(dl<=3){dlTxt=dl+'h lagi';dlCls='wn';}else dlTxt=dl+'h lagi';}
    const disps=Object.values(D.disposisi||{}).filter(d=>d.suratId===s.id);
    const cmts=Object.values(D.activity||{}).filter(a=>a.action==='KOMENTAR'&&a.suratId===s.id);
    const lc=cmts.sort((a,b)=>b.ts>a.ts?1:-1)[0];
    const clsMap={HIGH:'pH',MEDIUM:'pM',LOW:'pL'};
    const bdCS={DRAFT:'bD',PROSES:'bP',SELESAI:'bS',OVERDUE:'bO'};
    const bdPri={HIGH:'bH',MEDIUM:'bMed',LOW:'bL'};

    return '<div class="scard '+clsMap[s.prioritas]+'">'+
      '<div class="sr1">'+
        '<div style="flex:1;min-width:0">'+
          '<div class="smeta">'+esc(s.jenis)+(s.ref?' ¬∑ '+esc(s.ref):'')+'</div>'+
          '<div class="stitle">'+esc(s.judul)+'</div>'+
        '</div>'+
        '<div class="sbadges">'+
          '<span class="bdg '+bdPri[s.prioritas]+'">'+s.prioritas+'</span>'+
          '<span class="bdg '+bdCS[cs]+'">'+cs+'</span>'+
        '</div>'+
      '</div>'+
      '<div class="sinfo">'+
        (s.kepada?'<span class="si">üë§ '+esc(s.kepada)+'</span>':'')+
        (s.pic?'<span class="si">üîß '+esc(s.pic)+'</span>':'')+
        (s.deadline?'<span class="si '+dlCls+'">üìÖ '+fmtD(s.deadline)+' ‚Äî '+dlTxt+'</span>':'')+
        '<span class="si" style="color:var(--tx3)">oleh '+esc(s.createdBy||s.pic||'-')+'</span>'+
      '</div>'+
      (s.desc?'<div class="sdesc">'+esc(s.desc)+'</div>':'')+
      (disps.length?'<div style="font-family:var(--mono);font-size:9px;color:var(--tx3);margin-bottom:4px">Disposisi ('+disps.length+'):</div><div class="dchips">'+disps.map(d=>{const a=Object.values(D.anggota||{}).find(x=>x.id===d.anggotaId);const dc=d.done?'dn':(d.deadline&&dLeft(d.deadline)<0?'lt':'pn');return '<div class="dchip"><div class="dd '+dc+'"></div>'+(a?esc(a.nama):'?')+(d.done?' ‚úì':'')+'</div>';}).join('')+'</div>':'')+
      (lc?'<div class="cmt-prev"><div class="cmt-bubble"><strong>'+esc(lc.userName)+':</strong> '+esc(lc.extra)+'</div><span style="font-family:var(--mono);font-size:9px;color:var(--tx3);flex-shrink:0">'+fmtDT(lc.ts)+'</span></div>':'')+
      '<div class="sacts">'+
        '<button class="btn bsm bgst" onclick="openDetail(\''+s.id+'\')">üîç Detail</button>'+
        '<button class="btn bsm bwrn" onclick="openEdit(\''+s.id+'\')">‚úè Edit</button>'+
        '<button class="btn bsm binfo" onclick="openDisp(\''+s.id+'\')">‚Üí Disp</button>'+
        '<button class="btn bsm bpur" onclick="openKmt(\''+s.id+'\')">üí¨'+(cmts.length?' '+cmts.length:'')+'</button>'+
        (cs!=='SELESAI'?'<button class="btn bsm bsuc" onclick="qSelesai(\''+s.id+'\')">‚úì Selesai</button>':'')+
        '<button class="btn bsm bdng" onclick="cfmHapusSurat(\''+s.id+'\')">‚úï</button>'+
      '</div></div>';
  }).join('');
  updateStats();
}

// DETAIL
function openDetail(id){
  const s=Object.values(D.surat||{}).find(x=>x.id===id);if(!s)return;
  const cs=getCS(s),disps=Object.values(D.disposisi||{}).filter(d=>d.suratId===id);
  const hist=s.history||[],dl=s.deadline?dLeft(s.deadline):null;
  let dlTxt='';if(dl!==null){if(dl<0)dlTxt='<span style="color:var(--r)">‚ö† '+Math.abs(dl)+'h terlambat</span>';else if(dl===0)dlTxt='<span style="color:var(--w)">‚ö° Hari ini!</span>';else dlTxt='<span style="color:var(--g)">'+dl+' hari lagi</span>';}
  const cmts=Object.values(D.activity||{}).filter(a=>a.action==='KOMENTAR'&&a.suratId===id).sort((a,b)=>a.ts>b.ts?1:-1);
  const bdCS={DRAFT:'bD',PROSES:'bP',SELESAI:'bS',OVERDUE:'bO'},bdPri={HIGH:'bH',MEDIUM:'bMed',LOW:'bL'};

  document.getElementById('detailContent').innerHTML=
    '<div style="display:flex;gap:5px;margin-bottom:12px;flex-wrap:wrap">'+
      '<span class="bdg '+bdPri[s.prioritas]+'">'+s.prioritas+'</span>'+
      '<span class="bdg '+bdCS[cs]+'">'+cs+'</span>'+
      '<span class="bdg bP">'+esc(s.jenis)+'</span>'+
    '</div>'+
    '<div style="font-size:16px;font-weight:700;margin-bottom:12px;line-height:1.4">'+esc(s.judul)+'</div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">'+
      '<div><div style="font-family:var(--mono);font-size:9px;color:var(--tx3);margin-bottom:3px">KEPADA</div><div style="font-size:12px">'+esc(s.kepada||'-')+'</div></div>'+
      '<div><div style="font-family:var(--mono);font-size:9px;color:var(--tx3);margin-bottom:3px">PIC</div><div style="font-size:12px">'+esc(s.pic||'-')+'</div></div>'+
      '<div><div style="font-family:var(--mono);font-size:9px;color:var(--tx3);margin-bottom:3px">REF</div><div style="font-size:12px">'+esc(s.ref||'-')+'</div></div>'+
      '<div><div style="font-family:var(--mono);font-size:9px;color:var(--tx3);margin-bottom:3px">DEADLINE</div><div style="font-size:12px">'+(s.deadline?fmtD(s.deadline)+' ‚Äî '+dlTxt:'-')+'</div></div>'+
    '</div>'+
    (s.desc?'<div style="background:var(--bg);padding:9px 11px;border-radius:6px;border-left:3px solid var(--b2);font-size:11px;color:var(--tx2);line-height:1.55;margin-bottom:12px">'+esc(s.desc)+'</div>':'')+
    (disps.length?'<div style="margin-bottom:12px"><div style="font-family:var(--mono);font-size:9px;color:var(--tx3);margin-bottom:6px">DISPOSISI ('+disps.length+')</div>'+disps.map(d=>{const a=Object.values(D.anggota||{}).find(x=>x.id===d.anggotaId);const dc=d.done?'dn':(d.deadline&&dLeft(d.deadline)<0?'lt':'pn');return '<div style="display:flex;align-items:center;gap:7px;padding:7px 9px;background:var(--bg);border-radius:5px;border:1px solid var(--b1);margin-bottom:4px"><div class="dd '+dc+'" style="width:7px;height:7px;border-radius:50%;flex-shrink:0"></div><div style="flex:1"><div style="font-size:11px;font-weight:600">'+(a?esc(a.nama):'?')+'</div>'+(d.note?'<div style="font-size:10px;color:var(--tx2)">'+esc(d.note)+'</div>':'')+'</div>'+(d.deadline?'<div style="font-family:var(--mono);font-size:9px;color:var(--tx3)">'+fmtD(d.deadline)+'</div>':'')+'<span class="bdg '+(d.done?'bS':'bP')+'" style="font-size:8px">'+(d.done?'‚úì':'Aktif')+'</span></div>';}).join('')+'</div>':'')+
    '<div style="margin-bottom:12px">'+
      '<div style="font-family:var(--mono);font-size:9px;color:var(--tx3);margin-bottom:7px">üí¨ KOMENTAR ('+cmts.length+')</div>'+
      (cmts.length?cmts.map(c=>{const col=avC(c.userName);return '<div class="cmt-item"><div class="cmt-hdr"><div class="cmt-av" style="background:'+col+'22;border-color:'+col+';color:'+col+'">'+inits(c.userName)+'</div><div class="cmt-info"><div class="cmt-nm">'+esc(c.userName)+' <span style="font-size:9px;color:var(--tx3);font-family:var(--mono)">'+c.userRole+'</span></div><div class="cmt-tm">'+fmtDT(c.ts)+'</div></div>'+(c.userName===currentUser.nama?'<button class="cmt-del" onclick="delCmt(\''+c.id+'\',\''+id+'\')" title="Hapus komentar">‚úï</button>':'')+'</div><div class="cmt-txt">'+esc(c.extra)+'</div></div>';}).join(''):'')+
      '<div class="cmt-row"><input type="text" id="cmtI-'+id+'" placeholder="Tulis komentar..." onkeydown="if(event.key===\'Enter\')sendCmt(\''+id+'\')"><button class="btn bsm bpri" onclick="sendCmt(\''+id+'\')">Kirim</button></div>'+
    '</div>'+
    (hist.length?'<div><div style="font-family:var(--mono);font-size:9px;color:var(--tx3);margin-bottom:6px">üìã RIWAYAT STATUS</div>'+hist.slice().reverse().map(h=>'<div style="display:flex;gap:7px;margin-bottom:4px"><div style="width:6px;height:6px;border-radius:50%;background:var(--g);flex-shrink:0;margin-top:4px"></div><div style="flex:1;background:var(--bg);border-radius:5px;padding:6px 9px;border:1px solid var(--b1)"><div style="display:flex;justify-content:space-between;font-family:var(--mono);font-size:8px;margin-bottom:2px"><span style="color:var(--g);font-weight:700">'+h.status+'</span><span style="color:var(--tx3)">'+h.at+(h.by?' ¬∑ '+h.by:'')+'</span></div>'+(h.note?'<div style="font-size:10px;color:var(--tx2)">'+esc(h.note)+'</div>':'')+'</div></div>').join('')+'</div>':'');

  document.getElementById('detEditBtn').onclick=()=>{closeOv('ovDetail');openEdit(id);};
  document.getElementById('detDispBtn').onclick=()=>{closeOv('ovDetail');openDisp(id);};
  openOv('ovDetail');
}

// KOMENTAR
function openKmt(id){openDetail(id);setTimeout(()=>{const el=document.getElementById('cmtI-'+id);if(el){el.focus();el.scrollIntoView({behavior:'smooth'});}},250);}

function sendCmt(sid){
  const el=document.getElementById('cmtI-'+sid);if(!el)return;
  const txt=el.value.trim();if(!txt)return;
  const e={id:gid(),userId:currentUser.id,userName:currentUser.nama,userRole:currentUser.sysRole,action:'KOMENTAR',suratId:sid,suratJudul:'',extra:txt,ts:new Date().toISOString()};
  if(isDemo){D.activity[e.id]=e;onChanged();}else db.ref('activity/'+e.id).set(e);
  el.value='';
  setTimeout(()=>openDetail(sid),80);
  showToast('Komentar terkirim','success');
}

function delCmt(cid,sid){
  if(isDemo){delete D.activity[cid];onChanged();}else db.ref('activity/'+cid).remove();
  setTimeout(()=>openDetail(sid),80);
  showToast('Komentar dihapus','warn');
}

// TAMBAH SURAT
function tambahSurat(){
if(!canDo('add')){showToast('Anda tidak memiliki akses untuk menambah surat','error');return;}
  const judul=document.getElementById('iJudul').value.trim();
  const e=document.getElementById('tambahErr');
  if(!judul){e.textContent='‚ö† Judul wajib diisi';return;}
  e.textContent='';
  const id=gid();
  const s={id,judul,jenis:document.getElementById('iJenis').value,prioritas:document.getElementById('iPrio').value,status:'DRAFT',deadline:document.getElementById('iDl').value||'',kepada:document.getElementById('iKpd').value.trim(),pic:document.getElementById('iPIC').value.trim()||currentUser.nama,ref:document.getElementById('iRef').value.trim(),desc:document.getElementById('iDesc').value.trim(),createdAt:tod(),createdBy:currentUser.nama,history:[{status:'DRAFT',note:'Dibuat oleh '+currentUser.nama,at:tod(),by:currentUser.nama}]};
  dbW('surat/'+id,s);
  logAct('TAMBAH_SURAT',s.judul,'Prioritas: '+s.prioritas);
  clearForm();showToast('Surat disimpan','success');showPanel('daftar');
}

function clearForm(){
  ['iJudul','iDl','iKpd','iRef','iDesc'].forEach(i=>document.getElementById(i).value='');
  document.getElementById('iPIC').value=currentUser.nama;
  document.getElementById('iPrio').value='MEDIUM';
  document.getElementById('tambahErr').textContent='';
  cc('iJudul','ccj',200);cc('iDesc','ccd',1000);
}
function cc(id,cid,mx){const l=document.getElementById(id).value.length;const el=document.getElementById(cid);el.textContent=l+'/'+mx;el.style.color=l>mx*.85?'var(--w)':'var(--tx3)';}

// EDIT
function openEdit(id){
  const s=Object.values(D.surat||{}).find(x=>x.id===id);if(!s)return;
  document.getElementById('editId').value=id;
  document.getElementById('eJudul').value=s.judul;
  document.getElementById('eJenis').value=s.jenis;
  document.getElementById('ePrioritas').value=s.prioritas;
  // Populate status dropdown based on permissions
const statusSel=document.getElementById('eStatus');
const availStatuses=getStatusOpts(s.status);
statusSel.innerHTML=availStatuses.map(st=>'<option value="'+st+'">'+st.replace(/_/g,' ')+'</option>').join('');
statusSel.value=s.status;
// Show P-Office field only if SIAP_POFFICE
const poffWrap=document.getElementById('eNomorPOfficeWrap');
if(poffWrap){
  poffWrap.style.display=(s.status==='SIAP_POFFICE'||s.status==='DI_POFFICE')?'block':'none';
  if(s.status==='SIAP_POFFICE'&&!canDo('poffice')){
    document.getElementById('eNomorPOffice').disabled=true;
  }
}
  document.getElementById('eDl').value=s.deadline||'';
  document.getElementById('eKpd').value=s.kepada||'';
  document.getElementById('ePIC').value=s.pic||'';
  document.getElementById('eRef').value=s.ref||'';
  document.getElementById('eDesc').value=s.desc||'';
  document.getElementById('eNote').value='';
  openOv('ovEdit');
}

function saveEdit(){
  const id=document.getElementById('editId').value;
  const s=Object.values(D.surat||{}).find(x=>x.id===id);
  if(!s)return;
  if(!canDo('edit',s)){showToast('Anda tidak dapat edit surat ini','error');return;}
  
  const newStatus=document.getElementById('eStatus').value;
  const nomorPO=document.getElementById('eNomorPOffice')?document.getElementById('eNomorPOffice').value:'';
  
  // Validate P-Office number required before DI_POFFICE
  if(newStatus==='DI_POFFICE'&&!nomorPO){
    showToast('Nomor P-Office wajib diisi sebelum status DI_POFFICE','error');
    return;
  }
  
  // Validate Sekretaris can fill P-Office number
  if(nomorPO&&s.nomorPOffice!==nomorPO&&!canDo('poffice')){
    showToast('Hanya Sekretaris TS yang dapat isi Nomor P-Office','error');
    return;
  }
  const id=document.getElementById('editId').value;
  const s=Object.values(D.surat||{}).find(x=>x.id===id);if(!s)return;
  const judul=document.getElementById('eJudul').value.trim();
  if(!judul){showToast('Judul wajib diisi','error');return;}
  const nSt=document.getElementById('eStatus').value,note=document.getElementById('eNote').value.trim();
  const hist=[...(s.history||[])];
  if(nSt!==s.status||note)hist.push({status:nSt,note:note||'Diubah oleh '+currentUser.nama,at:tod(),by:currentUser.nama});
  const up={...s,judul,jenis:document.getElementById('eJenis').value,prioritas:document.getElementById('ePrioritas').value,status:nSt,deadline:document.getElementById('eDl').value||'',kepada:document.getElementById('eKpd').value.trim(),pic:document.getElementById('ePIC').value.trim(),ref:document.getElementById('eRef').value.trim(),desc:document.getElementById('eDesc').value.trim(),history:hist};
  dbW('surat/'+id,up);
  logAct('EDIT_SURAT',judul,'Status: '+nSt+(note?' ‚Äî '+note:''));
  closeOv('ovEdit');showToast('Surat diperbarui','success');
}

function qSelesai(id){
  const s=Object.values(D.surat||{}).find(x=>x.id===id);if(!s)return;
  const hist=[...(s.history||[]),{status:'SELESAI',note:'Ditandai selesai oleh '+currentUser.nama,at:tod(),by:currentUser.nama}];
  dbW('surat/'+id,{...s,status:'SELESAI',history:hist});
  logAct('SELESAI',s.judul,'');
  showToast('Surat SELESAI ‚úì','success');
}

function cfmHapusSurat(id){
const s=Object.values(D.surat||{}).find(x=>x.id===id);
if(!s)return;
if(!canDo('delete',s)){showToast('Hanya Manager yang dapat menghapus surat','error');return;}
  const s=Object.values(D.surat||{}).find(x=>x.id===id);if(!s)return;
  document.getElementById('cfmMsg').textContent='Hapus surat "'+s.judul.substring(0,60)+'"? Disposisi terkait juga dihapus.';
  pendingDel=()=>{
    dbR('surat/'+id);
    Object.values(D.disposisi||{}).filter(d=>d.suratId===id).forEach(d=>dbR('disposisi/'+d.id));
    logAct('HAPUS_SURAT',s.judul,'');
    closeOv('cfmOv');showToast('Surat dihapus','warn');
  };
  document.getElementById('cfmOkBtn').onclick=pendingDel;
  openOv('cfmOv');
}

// DISPOSISI
function openDisp(sid,did){
  const s=Object.values(D.surat||{}).find(x=>x.id===sid);if(!s)return;
  document.getElementById('dSuratId').value=sid;
  document.getElementById('dDispId').value=did||'';
  document.getElementById('dispInfo').innerHTML='<strong>'+esc(s.judul)+'</strong><br><span style="font-size:10px">'+esc(s.jenis)+' ¬∑ '+esc(s.ref||'-')+'</span>';
  const sel=document.getElementById('dAng');
  sel.innerHTML='<option value="">-- Pilih Anggota --</option>'+Object.values(D.anggota||{}).map(a=>'<option value="'+a.id+'">'+esc(a.nama)+' ‚Äî '+esc(a.jabatan)+'</option>').join('');
  if(did){const d=Object.values(D.disposisi||{}).find(x=>x.id===did);if(d){sel.value=d.anggotaId;document.getElementById('dDl').value=d.deadline||'';document.getElementById('dNote').value=d.note||'';}}
  else{document.getElementById('dDl').value=s.deadline||'';document.getElementById('dNote').value='';}
  openOv('ovDisp');
}

function saveDisp(){
  const sid=document.getElementById('dSuratId').value,did=document.getElementById('dDispId').value;
  const aid=document.getElementById('dAng').value;
  if(!aid){showToast('Pilih anggota','error');return;}
  const a=Object.values(D.anggota||{}).find(x=>x.id===aid);
  const note=document.getElementById('dNote').value.trim(),dl=document.getElementById('dDl').value;
  const s=Object.values(D.surat||{}).find(x=>x.id===sid);
  if(did){const d=Object.values(D.disposisi||{}).find(x=>x.id===did);if(d)dbW('disposisi/'+did,{...d,anggotaId:aid,note,deadline:dl});}
  else{
    const id=gid();
    dbW('disposisi/'+id,{id,suratId:sid,anggotaId:aid,note,deadline:dl,createdAt:tod(),createdBy:currentUser.nama,done:false});
    if(s&&s.status==='DRAFT'){const hist=[...(s.history||[]),{status:'PROSES',note:'Disposisi ke '+(a?a.nama:'?'),at:tod(),by:currentUser.nama}];dbW('surat/'+sid,{...s,status:'PROSES',history:hist});}
  }
  logAct('DISPOSISI',s?s.judul:'','Ke: '+(a?a.nama:'?')+(note?' ‚Äî '+note:''));
  closeOv('ovDisp');showToast('Disposisi '+(did?'diperbarui':'dikirim')+' ke '+(a?a.nama:'anggota'),'success');
}

function toggleTask(did){
  const d=Object.values(D.disposisi||{}).find(x=>x.id===did);if(!d)return;
  dbW('disposisi/'+did,{...d,done:!d.done});
  const s=Object.values(D.surat||{}).find(x=>x.id===d.suratId);
  logAct(d.done?'BUKA_TUGAS':'SELESAI_TUGAS',s?s.judul:'','');
  showToast(!d.done?'Tugas selesai ‚úì':'Tugas dibuka kembali','success');
}

function hapusDisp(did){
  document.getElementById('cfmMsg').textContent='Hapus disposisi ini?';
  pendingDel=()=>{dbR('disposisi/'+did);closeOv('cfmOv');showToast('Disposisi dihapus','warn');};
  document.getElementById('cfmOkBtn').onclick=pendingDel;
  openOv('cfmOv');
}

// REMINDER
function renderReminder(){
  const cont=document.getElementById('reminderList');
  const active=Object.values(D.surat||{}).filter(s=>s.status!=='SELESAI'&&s.deadline);
  document.getElementById('remCnt').textContent=active.length+' surat aktif';
  active.sort((a,b)=>new Date(a.deadline)-new Date(b.deadline));
  if(!active.length){cont.innerHTML='<div class="empty"><span class="empty-icon">üéâ</span>Tidak ada deadline aktif!</div>';return;}
  const ov=[],td=[],sn=[],ok=[];
  active.forEach(s=>{const d=dLeft(s.deadline);if(d<0)ov.push({...s,d});else if(d===0)td.push({...s,d});else if(d<=3)sn.push({...s,d});else ok.push({...s,d});});
  const grp=(items,lbl,col)=>!items.length?'':
    '<div style="font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:1px;color:'+col+';margin:11px 0 6px;padding-bottom:5px;border-bottom:1px solid var(--b1)">'+lbl+' ('+items.length+')</div>'+
    items.map(s=>{
      const d=s.d;let ic='ok',dc='ok',dt=d+'h lagi';
      if(d<0){ic='ov';dc='ov';dt=Math.abs(d)+'h TERLAMBAT';}else if(d===0){ic='td';dc='td';dt='HARI INI!';}else if(d<=3){ic='sn';dc='sn';}
      const cs=getCS(s);
      return '<div class="rem-card"><div class="rind '+ic+'"></div><div class="rbody"><div class="rtitle">'+esc(s.judul)+'</div><div class="rmeta">'+esc(s.jenis)+' ¬∑ '+esc(s.kepada||'-')+' ¬∑ PIC: '+esc(s.pic||'-')+'</div></div><div><div class="rdays '+dc+'">'+dt+'</div><div class="rdate">'+fmtD(s.deadline)+'</div><div style="display:flex;gap:3px;margin-top:4px;justify-content:flex-end"><button class="btn bsm bwrn" style="padding:2px 7px;font-size:8px" onclick="openEdit(\''+s.id+'\')">Edit</button><button class="btn bsm bsuc" style="padding:2px 7px;font-size:8px" onclick="qSelesai(\''+s.id+'\');renderReminder()">‚úì</button></div></div></div>';
    }).join('');
  cont.innerHTML=grp(ov,'üî¥ TERLAMBAT','var(--r)')+grp(td,'üü° HARI INI','var(--w)')+grp(sn,'üîµ 3 HARI KE DEPAN','var(--a)')+grp(ok,'üü¢ JADWAL OK','var(--g)');
}

// DISPOSISI PANEL
function renderDispPanel(){
  const cont=document.getElementById('dispTracker');
  const angs=Object.values(D.anggota||{});
  if(!angs.length){cont.innerHTML='<div class="empty"><span class="empty-icon">üë•</span>Belum ada anggota tim</div>';return;}
  cont.innerHTML='<div class="angGrid">'+angs.map(a=>{
    const tasks=Object.values(D.disposisi||{}).filter(d=>d.anggotaId===a.id);
    const done=tasks.filter(t=>t.done).length,pct=tasks.length?Math.round(done/tasks.length*100):0;
    const col=avC(a.nama);
    return '<div class="angCard">'+
      '<div class="angTop"><div class="angAv" style="background:'+col+'22;border-color:'+col+';color:'+col+'">'+inits(a.nama)+'</div>'+
      '<div style="flex:1"><div class="angName">'+esc(a.nama)+'</div><div class="angRole">'+esc(a.jabatan)+(a.kontak?' ¬∑ '+esc(a.kontak):'')+'</div></div>'+
      '<div><div class="angStats"><span class="bdg bP">'+(tasks.length-done)+' aktif</span><span class="bdg bS">'+done+' selesai</span></div>'+(tasks.length?'<div style="font-family:var(--mono);font-size:9px;color:var(--tx3);text-align:right;margin-top:2px">'+pct+'%</div>':'')+
      '</div></div>'+
      (tasks.length?'<div class="prog"><div class="prog-f '+(pct===100?'full':'')+'" style="width:'+pct+'%"></div></div>':'')+
      '<div class="task-list">'+(!tasks.length?'<div style="color:var(--tx3);font-size:10px;font-family:var(--mono);padding:4px 0">Tidak ada tugas aktif</div>':
        tasks.map(t=>{
          const s=Object.values(D.surat||{}).find(x=>x.id===t.suratId);
          const dR=t.deadline?dLeft(t.deadline):null;
          const dc=dR===null?'var(--tx3)':dR<0?'var(--r)':dR<=2?'var(--w)':'var(--tx3)';
          return '<div class="task-i '+(t.done?'dn':'')+'"><div class="tcb '+(t.done?'chk':'')+'" onclick="toggleTask(\''+t.id+'\')" title="Toggle selesai">'+(t.done?'‚úì':'')+'</div>'+
            '<div class="tlbl" title="'+(s?esc(s.judul):'(dihapus)')+'">'+
              '<div style="font-weight:600">'+(s?esc(s.judul.length>42?s.judul.substring(0,42)+'...':s.judul):'(dihapus)')+'</div>'+
              (t.note?'<div style="color:var(--tx2);font-size:9px">'+esc(t.note)+'</div>':'')+
            '</div>'+
            (t.deadline?'<div class="tdl" style="color:'+dc+'">'+fmtD(t.deadline)+'</div>':'')+
            '<div style="display:flex;gap:2px;flex-shrink:0">'+
              (s?'<button class="btn bsm bgst" style="padding:2px 5px;font-size:8px" onclick="openDisp(\''+t.suratId+'\',\''+t.id+'\')">‚úè</button>':'')+
              '<button class="btn bsm bdng" style="padding:2px 5px;font-size:8px" onclick="hapusDisp(\''+t.id+'\')">‚úï</button>'+
            '</div></div>';
        }).join(''))+
      '</div></div>';
  }).join('')+'</div>';
}

// ACTIVITY
function renderActivity(){
  const cont=document.getElementById('activityFeed');
  const acts=Object.values(D.activity||{}).filter(a=>a.action!=='LOGIN').sort((a,b)=>b.ts>a.ts?1:-1).slice(0,100);
  document.getElementById('actCnt').textContent=acts.length+' entri';
  if(!acts.length){cont.innerHTML='<div class="empty"><span class="empty-icon">üì≠</span>Belum ada aktivitas</div>';return;}
  const ics={TAMBAH_SURAT:'‚úö',EDIT_SURAT:'‚úè',HAPUS_SURAT:'‚úï',DISPOSISI:'‚Üí',SELESAI:'‚úì',SELESAI_TUGAS:'‚úì',BUKA_TUGAS:'‚Ü∫',KOMENTAR:'üí¨',TAMBAH_ANGGOTA:'üë§'};
  const cls={TAMBAH_SURAT:'var(--g)',EDIT_SURAT:'var(--w)',HAPUS_SURAT:'var(--r)',DISPOSISI:'var(--a)',SELESAI:'var(--g)',SELESAI_TUGAS:'var(--g)',BUKA_TUGAS:'var(--tx2)',KOMENTAR:'var(--p)',TAMBAH_ANGGOTA:'var(--a)'};
  cont.innerHTML=acts.map(a=>{
    const col=cls[a.action]||'var(--tx2)',ic=ics[a.action]||'‚Ä¢',uc=avC(a.userName||'?');
    return '<div class="act-item"><div class="act-av" style="background:'+uc+'22;border-color:'+uc+';color:'+uc+'">'+inits(a.userName||'?')+'</div><div class="act-body"><div class="act-who">'+esc(a.userName)+' <span style="font-family:var(--mono);font-size:9px;color:var(--tx3)">'+esc(a.userRole||'')+'</span></div><div class="act-what"><span class="act-tag" style="color:'+col+';border-color:'+col+'1a;background:'+col+'10">'+ic+' '+a.action.replace(/_/g,' ')+'</span>'+(a.suratJudul?'"<strong>'+esc(a.suratJudul.substring(0,50))+'</strong>" ':''+(a.extra?'‚Äî '+esc(a.extra):''))+'</div><div class="act-when">'+fmtDT(a.ts)+'</div></div></div>';
  }).join('');
}

// NOTIF
function renderNotif(){
  const cont=document.getElementById('notifContent');
  const ov=Object.values(D.surat||{}).filter(s=>getCS(s)==='OVERDUE');
  const td=Object.values(D.surat||{}).filter(s=>s.status!=='SELESAI'&&s.deadline&&dLeft(s.deadline)===0);
  const me=Object.values(D.anggota||{}).find(x=>x.nama===currentUser.nama);
  const myD=me?Object.values(D.disposisi||{}).filter(d=>d.anggotaId===me.id&&!d.done):[];
  if(!ov.length&&!td.length&&!myD.length){cont.innerHTML='<div style="color:var(--tx3);font-family:var(--mono);font-size:11px;padding:20px;text-align:center">‚úÖ Tidak ada notifikasi aktif</div>';return;}
  let h='';
  ov.forEach(s=>{h+='<div class="ni"><div class="ni-icon">üî¥</div><div class="ni-body"><div class="ni-msg"><strong>'+esc(s.judul)+'</strong> ‚Äî <span style="color:var(--r)">OVERDUE '+Math.abs(dLeft(s.deadline))+' hari</span></div><div class="ni-time">Deadline: '+fmtD(s.deadline)+'</div></div></div>';});
  td.forEach(s=>{h+='<div class="ni"><div class="ni-icon">üü°</div><div class="ni-body"><div class="ni-msg"><strong>'+esc(s.judul)+'</strong> ‚Äî <span style="color:var(--w)">HARI INI!</span></div><div class="ni-time">'+esc(s.jenis)+' ¬∑ PIC: '+esc(s.pic||'-')+'</div></div></div>';});
  myD.forEach(d=>{const s=Object.values(D.surat||{}).find(x=>x.id===d.suratId);h+='<div class="ni"><div class="ni-icon">üìã</div><div class="ni-body"><div class="ni-msg">Tugas: <strong>'+(s?esc(s.judul.substring(0,50)):'?')+'</strong></div><div class="ni-time">'+(d.note?esc(d.note)+' ¬∑ ':'')+' Deadline: '+fmtD(d.deadline)+'</div></div></div>';});
  cont.innerHTML=h;
}

// ANGGOTA
function tambahAnggota(){
if(!canDo('anggota')){showToast('Hanya Manager yang dapat kelola anggota','error');return;}
  const nama=document.getElementById('iNama').value.trim();
  const e=document.getElementById('angErr');
  if(!nama){e.textContent='‚ö† Nama wajib diisi';return;}
  if(Object.values(D.anggota||{}).find(a=>a.nama.toLowerCase()===nama.toLowerCase())){e.textContent='‚ö† Nama sudah ada';return;}
  e.textContent='';
  const id=gid();
  dbW('anggota/'+id,{id,nama,jabatan:document.getElementById('iJabatan').value.trim(),kontak:document.getElementById('iKontak').value.trim()});
  logAct('TAMBAH_ANGGOTA',nama,'');
  ['iNama','iJabatan','iKontak'].forEach(i=>document.getElementById(i).value='');
  showToast('"'+nama+'" ditambahkan','success');
}

function editAnggota(id){
  const a=Object.values(D.anggota||{}).find(x=>x.id===id);if(!a)return;
  const n=prompt('Nama:',a.nama);if(!n||!n.trim())return;
  const j=prompt('Jabatan:',a.jabatan||'');
  const k=prompt('Kontak:',a.kontak||'');
  dbW('anggota/'+id,{...a,nama:n.trim(),jabatan:(j||'').trim(),kontak:(k||'').trim()});
  showToast('Anggota diperbarui','success');
}

function cfmHapusAnggota(id){
  const a=Object.values(D.anggota||{}).find(x=>x.id===id);if(!a)return;
  const cnt=Object.values(D.disposisi||{}).filter(d=>d.anggotaId===id).length;
  document.getElementById('cfmMsg').textContent='Hapus "'+a.nama+'"?'+(cnt?' '+cnt+' disposisi ikut dihapus.':'');
  pendingDel=()=>{
    dbR('anggota/'+id);
    Object.values(D.disposisi||{}).filter(d=>d.anggotaId===id).forEach(d=>dbR('disposisi/'+d.id));
    closeOv('cfmOv');showToast('Anggota dihapus','warn');
  };
  document.getElementById('cfmOkBtn').onclick=pendingDel;
  openOv('cfmOv');
}

function renderAngGrid(){
  const g=document.getElementById('angGrid');
  const angs=Object.values(D.anggota||{});
  if(!angs.length){g.innerHTML='<div class="empty" style="grid-column:1/-1"><span class="empty-icon">üë§</span>Belum ada anggota</div>';return;}
  g.innerHTML=angs.map(a=>{
    const tot=Object.values(D.disposisi||{}).filter(d=>d.anggotaId===a.id).length;
    const dn=Object.values(D.disposisi||{}).filter(d=>d.anggotaId===a.id&&d.done).length;
    const col=avC(a.nama);
    return '<div class="angCard"><div class="angTop"><div class="angAv" style="background:'+col+'22;border-color:'+col+';color:'+col+'">'+inits(a.nama)+'</div><div style="flex:1"><div class="angName">'+esc(a.nama)+'</div><div class="angRole">'+esc(a.jabatan||'-')+(a.kontak?' ¬∑ '+esc(a.kontak):'')+'</div></div><div style="display:flex;gap:4px"><button class="btn bsm bgst" onclick="editAnggota(\''+a.id+'\')">‚úè</button><button class="btn bsm bdng" onclick="cfmHapusAnggota(\''+a.id+'\')">‚úï</button></div></div><div class="angStats"><span class="bdg bP">'+(tot-dn)+' aktif</span><span class="bdg bS">'+dn+' selesai</span><span class="bdg bD">'+tot+' total</span></div></div>';
  }).join('');
}

// OVERLAY
function openOv(id){document.getElementById(id).classList.add('open');}
function closeOv(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.ov').forEach(o=>{o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');});});
document.addEventListener('keydown',e=>{if(e.key==='Escape')document.querySelectorAll('.ov.open').forEach(o=>o.classList.remove('open'));});

// TOAST
function showToast(msg,type='success'){
  const wrap=document.getElementById('tw'),t=document.createElement('div');
  t.className='toast t'+type[0];
  t.innerHTML='<span>'+{success:'‚úì',error:'‚úï',warn:'‚ö†',info:'‚Ñπ'}[type]+'</span><span style="flex:1">'+esc(msg)+'</span><span class="tclose" onclick="this.parentElement.remove()">‚úï</span>';
  wrap.appendChild(t);
  setTimeout(()=>{t.style.transition='.3s';t.style.opacity='0';t.style.transform='translateX(110%)';setTimeout(()=>{if(t.parentElement)t.remove();},300);},4000);
}

// INIT
(function(){
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyDGoTKyse6Eu-HCiP8Iyo5wRNOlWIflF3k",
    authDomain: "kpb-surat-tim.firebaseapp.com",
    databaseURL: "https://kpb-surat-tim-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "kpb-surat-tim",
    storageBucket: "kpb-surat-tim.firebasestorage.app",
    messagingSenderId: "1089579741546",
    appId: "1:1089579741546:web:da21a0a9fdf672e1147513"
  };
  const savedUser=localStorage.getItem(USER_KEY);
  localStorage.setItem(CFG_KEY,JSON.stringify(FIREBASE_CONFIG));
  document.getElementById('loadingScreen').classList.add('hidden');
  try{
    if(firebase.apps.length>0){
      firebase.apps[0].delete().then(()=>{
        firebase.initializeApp(FIREBASE_CONFIG);
        db=firebase.database();
        if(savedUser){currentUser=JSON.parse(savedUser);startApp();}else{showLogin();}
      });
    }else{
      firebase.initializeApp(FIREBASE_CONFIG);
      db=firebase.database();
      if(savedUser){currentUser=JSON.parse(savedUser);startApp();}else{showLogin();}
    }
  }catch(err){console.error('Firebase:',err);alert('Koneksi Firebase gagal');showLogin();}
})();
</script>
</body>
</html>
